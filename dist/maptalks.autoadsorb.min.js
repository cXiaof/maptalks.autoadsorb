/*!
 * maptalks.autoadsorb v0.4.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
/*!
 * requires maptalks@>=0.46.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(e,o){"use strict";var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=6371008.8,n={centimeters:100*t,centimetres:100*t,degrees:t/111325,feet:3.28084*t,inches:39.37*t,kilometers:t/1e3,kilometres:t/1e3,meters:t,metres:t,miles:t/1609.344,millimeters:1e3*t,millimetres:1e3*t,nauticalmiles:t/1852,radians:1,yards:1.0936*t},i={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046};function c(e,t,r){var o={type:"Feature"};return 0!==(r=void 0===r?{}:r).id&&!r.id||(o.id=r.id),r.bbox&&(o.bbox=r.bbox),o.properties=t||{},o.geometry=e,o}function l(e,t,r){if(void 0===r&&(r={}),!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(f(e[0])&&f(e[1]))return c({type:"Point",coordinates:e},t,r);throw new Error("coordinates must contain numbers")}function s(e,t,r){void 0===r&&(r={});for(var o=0,n=e;o<n.length;o++){var i=n[o];if(i.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var s=0;s<i[i.length-1].length;s++)if(i[i.length-1][s]!==i[0][s])throw new Error("First and last Position are not equivalent.")}return c({type:"Polygon",coordinates:e},t,r)}function d(e,t,r){if(void 0===r&&(r={}),e.length<2)throw new Error("coordinates must be an array of two or more positions");return c({type:"LineString",coordinates:e},t,r)}function u(e,t){var r={type:"FeatureCollection"};return(t=void 0===t?{}:t).id&&(r.id=t.id),t.bbox&&(r.bbox=t.bbox),r.features=e,r}function a(e,t,r){return c({type:"MultiLineString",coordinates:e},t,r=void 0===r?{}:r)}function G(e,t,r){return c({type:"MultiPoint",coordinates:e},t,r=void 0===r?{}:r)}function j(e,t,r){return c({type:"MultiPolygon",coordinates:e},t,r=void 0===r?{}:r)}function N(e,t){var r=n[t=void 0===t?"kilometers":t];if(r)return e*r;throw new Error(t+" units is invalid")}function h(e,t){var r=n[t=void 0===t?"kilometers":t];if(r)return e/r;throw new Error(t+" units is invalid")}function R(e){return 180*(e%(2*Math.PI))/Math.PI}function f(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function p(e){return!!e&&e.constructor===Object}t=Object.freeze({earthRadius:t,factors:n,unitsFactors:{centimeters:100,centimetres:100,degrees:1/111325,feet:3.28084,inches:39.37,kilometers:.001,kilometres:.001,meters:1,metres:1,miles:1/1609.344,millimeters:1e3,millimetres:1e3,nauticalmiles:1/1852,radians:1/t,yards:1.0936133},areaFactors:i,feature:c,geometry:function(e,t,r){switch(void 0===r&&(r={}),e){case"Point":return l(t).geometry;case"LineString":return d(t).geometry;case"Polygon":return s(t).geometry;case"MultiPoint":return G(t).geometry;case"MultiLineString":return a(t).geometry;case"MultiPolygon":return j(t).geometry;default:throw new Error(e+" is invalid")}},point:l,points:function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return l(e,t)}),r)},polygon:s,polygons:function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return s(e,t)}),r)},lineString:d,lineStrings:function(e,t,r){return void 0===r&&(r={}),u(e.map(function(e){return d(e,t)}),r)},featureCollection:u,multiLineString:a,multiPoint:G,multiPolygon:j,geometryCollection:function(e,t,r){return c({type:"GeometryCollection",geometries:e},t,r=void 0===r?{}:r)},round:function(e,t){if(!(t=void 0===t?0:t)||0<=t)return t=Math.pow(10,t||0),Math.round(e*t)/t;throw new Error("precision must be a positive number")},radiansToLength:N,lengthToRadians:h,lengthToDegrees:function(e,t){return R(h(e,t))},bearingToAzimuth:function(e){return(e%=360)<0&&(e+=360),e},radiansToDegrees:R,degreesToRadians:function(e){return e%360*Math.PI/180},convertLength:function(e,t,r){if(void 0===t&&(t="kilometers"),void 0===r&&(r="kilometers"),0<=e)return N(h(e,t),r);throw new Error("length must be a positive number")},convertArea:function(e,t,r){if(void 0===t&&(t="meters"),void 0===r&&(r="kilometers"),!(0<=e))throw new Error("area must be a positive number");if(!(t=i[t]))throw new Error("invalid original units");if(r=i[r])return e/t*r;throw new Error("invalid final units")},isNumber:f,isObject:p,validateBBox:function(e){if(!e)throw new Error("bbox is required");if(!Array.isArray(e))throw new Error("bbox must be an Array");if(4!==e.length&&6!==e.length)throw new Error("bbox must be an Array of 4 or 6 numbers");e.forEach(function(e){if(!f(e))throw new Error("bbox must only contain numbers")})},validateId:function(e){if(!e)throw new Error("id is required");if(-1===["string","number"].indexOf(void 0===e?"undefined":T(e)))throw new Error("id must be a number or a string")}});function x(e,t,r){if(null!==e)for(var o,n,i,s=0,a=e.type,u="FeatureCollection"===a,l="Feature"===a,c=u?e.features.length:1,h=0;h<c;h++)for(var f,p,d=(p=!!(f=u?e.features[h].geometry:l?e.geometry:e)&&"GeometryCollection"===f.type)?f.geometries.length:1,m=0;m<d;m++){var y=0,g=0,v=p?f.geometries[m]:f;if(null!==v){var _=v.coordinates,b=v.type,w=!r||"Polygon"!==b&&"MultiPolygon"!==b?0:1;switch(b){case null:break;case"Point":if(!1===t(_,s,h,y,g))return!1;s++,y++;break;case"LineString":case"MultiPoint":for(o=0;o<_.length;o++){if(!1===t(_[o],s,h,y,g))return!1;s++,"MultiPoint"===b&&y++}"LineString"===b&&y++;break;case"Polygon":case"MultiLineString":for(o=0;o<_.length;o++){for(n=0;n<_[o].length-w;n++){if(!1===t(_[o][n],s,h,y,g))return!1;s++}"MultiLineString"===b&&y++,"Polygon"===b&&g++}"Polygon"===b&&y++;break;case"MultiPolygon":for(o=0;o<_.length;o++){for(n=g=0;n<_[o].length;n++){for(i=0;i<_[o][n].length-w;i++){if(!1===t(_[o][n][i],s,h,y,g))return!1;s++}g++}y++}break;case"GeometryCollection":for(o=0;o<v.geometries.length;o++)if(!1===x(v.geometries[o],t,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}function I(e,t){var r;switch(e.type){case"FeatureCollection":for(r=0;r<e.features.length&&!1!==t(e.features[r].properties,r);r++);break;case"Feature":t(e.properties,0)}}function m(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(var r=0;r<e.features.length&&!1!==t(e.features[r],r);r++);}function r(e,t){for(var r,o,n,i,s,a,u,l,c,h=0,f="FeatureCollection"===e.type,p="Feature"===e.type,d=f?e.features.length:1,m=0;m<d;m++){for(s=f?e.features[m].geometry:p?e.geometry:e,u=f?e.features[m].properties:p?e.properties:{},l=f?e.features[m].bbox:p?e.bbox:void 0,c=f?e.features[m].id:p?e.id:void 0,i=(a=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,o=0;o<i;o++)if(null===(n=a?s.geometries[o]:s)){if(!1===t(null,h,u,l,c))return!1}else switch(n.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(n,h,u,l,c))return!1;break;case"GeometryCollection":for(r=0;r<n.geometries.length;r++)if(!1===t(n.geometries[r],h,u,l,c))return!1;break;default:throw new Error("Unknown Geometry Type")}h++}}function y(e,l){r(e,function(e,t,r,o,n){var i,s=null===e?null:e.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return!1===l(c(e,r,{bbox:o,id:n}),t,0)?!1:void 0}switch(s){case"MultiPoint":i="Point";break;case"MultiLineString":i="LineString";break;case"MultiPolygon":i="Polygon"}for(var a=0;a<e.coordinates.length;a++){var u=e.coordinates[a];if(!1===l(c({type:i,coordinates:u},r),t,a))return!1}})}function D(e,p){y(e,function(i,s,a){var u=0;if(i.geometry){var l,c,h,f,e=i.geometry.type;if("Point"!==e&&"MultiPoint"!==e)return f=h=c=0,!1!==x(i,function(e,t,r,o,n){return void 0===l||c<s||h<o||f<n?(l=e,c=s,h=o,f=n,void(u=0)):(o=d([l,e],i.properties),!1!==p(o,s,a,n,u)&&(u++,void(l=e)))})&&void 0}})}function J(e,s){if(!e)throw new Error("geojson is required");y(e,function(e,t,r){if(null!==e.geometry){var o=e.geometry.type,n=e.geometry.coordinates;switch(o){case"LineString":if(!1===s(e,t,r,0,0))return!1;break;case"Polygon":for(var i=0;i<n.length;i++)if(!1===s(d(n[i],e.properties),t,r,i))return!1}}})}var q=Object.freeze({coordAll:function(e){var t=[];return x(e,function(e){t.push(e)}),t},coordEach:x,coordReduce:function(e,i,s,t){var a=s;return x(e,function(e,t,r,o,n){a=0===t&&void 0===s?e:i(a,e,t,r,o,n)},t),a},featureEach:m,featureReduce:function(e,r,o){var n=o;return m(e,function(e,t){n=0===t&&void 0===o?e:r(n,e,t)}),n},findPoint:function(e,t){if(!p(t=t||{}))throw new Error("options is invalid");var r,o=t.featureIndex||0,n=t.multiFeatureIndex||0,i=t.geometryIndex||0,s=t.coordIndex||0,a=t.properties;switch(e.type){case"FeatureCollection":o<0&&(o=e.features.length+o),a=a||e.features[o].properties,r=e.features[o].geometry;break;case"Feature":a=a||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":return l(u,a,t);case"MultiPoint":return l(u[n=n<0?u.length+n:n],a,t);case"LineString":return l(u[s=s<0?u.length+s:s],a,t);case"Polygon":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s),l(u[i][s],a,t);case"MultiLineString":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s),l(u[n][s],a,t);case"MultiPolygon":return n<0&&(n=u.length+n),i<0&&(i=u[n].length+i),s<0&&(s=u[n][i].length-s),l(u[n][i][s],a,t)}throw new Error("geojson is invalid")},findSegment:function(e,t){if(!p(t=t||{}))throw new Error("options is invalid");var r,o=t.featureIndex||0,n=t.multiFeatureIndex||0,i=t.geometryIndex||0,s=t.segmentIndex||0,a=t.properties;switch(e.type){case"FeatureCollection":o<0&&(o=e.features.length+o),a=a||e.features[o].properties,r=e.features[o].geometry;break;case"Feature":a=a||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":case"MultiPoint":return null;case"LineString":return d([u[s=s<0?u.length+s-1:s],u[s+1]],a,t);case"Polygon":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s-1),d([u[i][s],u[i][s+1]],a,t);case"MultiLineString":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s-1),d([u[n][s],u[n][s+1]],a,t);case"MultiPolygon":return n<0&&(n=u.length+n),i<0&&(i=u[n].length+i),s<0&&(s=u[n][i].length-s-1),d([u[n][i][s],u[n][i][s+1]],a,t)}throw new Error("geojson is invalid")},flattenEach:y,flattenReduce:function(e,o,n){var i=n;return y(e,function(e,t,r){i=0===t&&0===r&&void 0===n?e:o(i,e,t,r)}),i},geomEach:r,geomReduce:function(e,i,s){var a=s;return r(e,function(e,t,r,o,n){a=0===t&&void 0===s?e:i(a,e,t,r,o,n)}),a},lineEach:J,lineReduce:function(e,n,i){var s=i;return J(e,function(e,t,r,o){s=0===t&&void 0===i?e:n(s,e,t,r,o)}),s},propEach:I,propReduce:function(e,r,o){var n=o;return I(e,function(e,t){n=0===t&&void 0===o?e:r(n,e,t)}),n},segmentEach:D,segmentReduce:function(e,i,s){var a=s,u=!1;return D(e,function(e,t,r,o,n){a=!1===u&&void 0===s?e:i(a,e,t,r,o,n),u=!0}),a}});function z(t){var r=[];return"FeatureCollection"===t.type?m(t,function(t){x(t,function(e){r.push(l(e,t.properties))})}):x(t,function(e){r.push(l(e,t.properties))}),u(r)}function g(e){if(!e)throw new Error("geojson is required");var t=[];return y(e,function(e){t.push(e)}),u(t)}function v(e){return"Feature"===e.type?e.geometry:e}function U(e,t){void 0===t&&(t={});var r,o,n,i,s,a=v(e);switch(t.properties||"Feature"!==e.type||(t.properties=e.properties),a.type){case"Polygon":return void 0===(i=t)&&(i={}),s=v(n=a).coordinates,i=i.properties||("Feature"===n.type?n.properties:{}),V(s,i);case"MultiPolygon":return void 0===(n=t)&&(n={}),i=v(s=a).coordinates,r=n.properties||("Feature"===s.type?s.properties:{}),o=[],i.forEach(function(e){o.push(V(e,r))}),u(o);default:throw new Error("invalid poly")}}function V(e,t){return 1<e.length?a(e,t):d(e[0],t)}function W(e,t,r,o,n){!function e(t,r,o,n,i){for(;o<n;){600<n-o&&(s=n-o+1,c=r-o+1,u=Math.log(s),a=.5*Math.exp(2*u/3),u=.5*Math.sqrt(u*a*(s-a)/s)*(c-s/2<0?-1:1),l=Math.max(o,Math.floor(r-c*a/s+u)),c=Math.min(n,Math.floor(r+(s-c)*a/s+u)),e(t,r,l,c,i));var s,a,u,l,c,h=t[r],f=o,p=n;for(_(t,o,r),0<i(t[n],h)&&_(t,o,n);f<p;){for(_(t,f,p),f++,p--;i(t[f],h)<0;)f++;for(;0<i(t[p],h);)p--}0===i(t[o],h)?_(t,o,p):_(t,++p,n),p<=r&&(o=p+1),r<=p&&(n=p-1)}}(e,t,r||0,o||e.length-1,n||H)}function _(e,t,r){var o=e[t];e[t]=e[r],e[r]=o}function H(e,t){return e<t?-1:t<e?1:0}b.prototype.all=function(){return this._all(this.data,[])},b.prototype.search=function(e){var t=this.data,r=[];if(!k(e,t))return r;for(var o=this.toBBox,n=[];t;){for(var i=0;i<t.children.length;i++){var s=t.children[i],a=t.leaf?o(s):s;k(e,a)&&(t.leaf?r.push(s):L(e,a)?this._all(s,r):n.push(s))}t=n.pop()}return r},b.prototype.collides=function(e){var t=this.data;if(!k(e,t))return!1;for(var r=[];t;){for(var o=0;o<t.children.length;o++){var n=t.children[o],i=t.leaf?this.toBBox(n):n;if(k(e,i)){if(t.leaf||L(e,i))return!0;r.push(n)}}t=r.pop()}return!1},b.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0;t<e.length;t++)this.insert(e[t]);return this}var r,o=this._build(e.slice(),0,e.length-1,0);return this.data.children.length?this.data.height===o.height?this._splitRoot(this.data,o):(this.data.height<o.height&&(r=this.data,this.data=o,o=r),this._insert(o,this.data.height-o.height-1,!0)):this.data=o,this},b.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},b.prototype.clear=function(){return this.data=F([]),this},b.prototype.remove=function(e,t){if(!e)return this;for(var r=this.data,o=this.toBBox(e),n=[],i=[],s=void 0,a=void 0,u=void 0;r||n.length;){if(r||(r=n.pop(),a=n[n.length-1],s=i.pop(),u=!0),r.leaf){var l=function(e,t,r){if(!r)return t.indexOf(e);for(var o=0;o<t.length;o++)if(r(e,t[o]))return o;return-1}(e,r.children,t);if(-1!==l)return r.children.splice(l,1),n.push(r),this._condense(n),this}u||r.leaf||!L(r,o)?a?(s++,r=a.children[s],u=!1):r=null:(n.push(r),i.push(s),r=(a=r).children[s=0])}return this},b.prototype.toBBox=function(e){return e},b.prototype.compareMinX=function(e,t){return e.minX-t.minX},b.prototype.compareMinY=function(e,t){return e.minY-t.minY},b.prototype.toJSON=function(){return this.data},b.prototype.fromJSON=function(e){return this.data=e,this},b.prototype._all=function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},b.prototype._build=function(e,t,r,o){var n=r-t+1,i=this._maxEntries,s=void 0;if(n<=i)return w(s=F(e.slice(t,r+1)),this.toBBox),s;o||(o=Math.ceil(Math.log(n)/Math.log(i)),i=Math.ceil(n/Math.pow(i,o-1))),(s=F([])).leaf=!1,s.height=o;var a=Math.ceil(n/i),u=a*Math.ceil(Math.sqrt(i));$(e,t,r,u,this.compareMinX);for(var l=t;l<=r;l+=u){var c=Math.min(l+u-1,r);$(e,l,c,a,this.compareMinY);for(var h=l;h<=c;h+=a){var f=Math.min(h+a-1,c);s.children.push(this._build(e,h,f,o-1))}}return w(s,this.toBBox),s},b.prototype._chooseSubtree=function(e,t,r,o){for(;;){if(o.push(t),t.leaf||o.length-1===r)break;for(var n=1/0,i=1/0,s=void 0,a=0;a<t.children.length;a++){var u=t.children[a],l=E(u),c=(h=e,c=u,(Math.max(c.maxX,h.maxX)-Math.min(c.minX,h.minX))*(Math.max(c.maxY,h.maxY)-Math.min(c.minY,h.minY))-l);c<i?(i=c,n=l<n?l:n,s=u):c===i&&l<n&&(n=l,s=u)}t=s||t.children[0]}var h,c;return t},b.prototype._insert=function(e,t,r){var r=r?e:this.toBBox(e),o=[],n=this._chooseSubtree(r,this.data,t,o);for(n.children.push(e),M(n,r);0<=t&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(r,o,t)},b.prototype._split=function(e,t){var r=e[t],o=r.children.length,n=this._minEntries,n=(this._chooseSplitAxis(r,n,o),this._chooseSplitIndex(r,n,o)),o=F(r.children.splice(n,r.children.length-n));o.height=r.height,o.leaf=r.leaf,w(r,this.toBBox),w(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(r,o)},b.prototype._splitRoot=function(e,t){this.data=F([e,t]),this.data.height=e.height+1,this.data.leaf=!1,w(this.data,this.toBBox)},b.prototype._chooseSplitIndex=function(e,t,r){for(var o,n,i,s=void 0,a=1/0,u=1/0,l=t;l<=r-t;l++){var c=P(e,0,l,this.toBBox),h=P(e,l,r,this.toBBox),f=(o=c,f=h,p=i=n=void 0,n=Math.max(o.minX,f.minX),i=Math.max(o.minY,f.minY),p=Math.min(o.maxX,f.maxX),o=Math.min(o.maxY,f.maxY),Math.max(0,p-n)*Math.max(0,o-i)),p=E(c)+E(h);f<a?(a=f,s=l,u=p<u?p:u):f===a&&p<u&&(u=p,s=l)}return s||r-t},b.prototype._chooseSplitAxis=function(e,t,r){var o=e.leaf?this.compareMinX:Q,n=e.leaf?this.compareMinY:Z;this._allDistMargin(e,t,r,o)<this._allDistMargin(e,t,r,n)&&e.children.sort(o)},b.prototype._allDistMargin=function(e,t,r,o){e.children.sort(o);for(var n=this.toBBox,i=P(e,0,t,n),s=P(e,r-t,r,n),a=S(i)+S(s),u=t;u<r-t;u++){var l=e.children[u];M(i,e.leaf?n(l):l),a+=S(i)}for(var c=r-t-1;t<=c;c--){var h=e.children[c];M(s,e.leaf?n(h):h),a+=S(s)}return a},b.prototype._adjustParentBBoxes=function(e,t,r){for(var o=r;0<=o;o--)M(t[o],e)},b.prototype._condense=function(e){for(var t,r=e.length-1;0<=r;r--)0===e[r].children.length?0<r?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():w(e[r],this.toBBox)};var K=b;function b(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:9,t=this,r=b;if(!(t instanceof r))throw new TypeError("Cannot call a class as a function");this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}function w(e,t){P(e,0,e.children.length,t,e)}function P(e,t,r,o,n){(n=n||F(null)).minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var i=t;i<r;i++){var s=e.children[i];M(n,e.leaf?o(s):s)}return n}function M(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function Q(e,t){return e.minX-t.minX}function Z(e,t){return e.minY-t.minY}function E(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function S(e){return e.maxX-e.minX+(e.maxY-e.minY)}function L(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function k(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function F(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function $(e,t,r,o,n){for(var i,s=[t,r];s.length;)(r=s.pop())-(t=s.pop())<=o||(W(e,i=t+Math.ceil((r-t)/o/2)*o,t,r,n),s.push(t,i,i,r))}var B=Object.freeze({default:K});function O(e){var t=[1/0,1/0,-1/0,-1/0];return x(e,function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])}),t}O.default=O;var ee=Object.freeze({default:O}),X=B&&K,Y=(ee&&O).default,te=q.featureEach,re=t.featureCollection;function oe(e){e=new X(e);return e.insert=function(e){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox||Y(e),X.prototype.insert.call(this,e)},e.load=function(e){var t=[];return Array.isArray(e)?e.forEach(function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox||Y(e),t.push(e)}):te(e,function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox||Y(e),t.push(e)}),X.prototype.load.call(this,t)},e.remove=function(e,t){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox||Y(e),X.prototype.remove.call(this,e,t)},e.clear=function(){return X.prototype.clear.call(this)},e.search=function(e){e=X.prototype.search.call(this,this.toBBox(e));return re(e)},e.collides=function(e){return X.prototype.collides.call(this,this.toBBox(e))},e.all=function(){var e=X.prototype.all.call(this);return re(e)},e.toJSON=function(){return X.prototype.toJSON.call(this)},e.fromJSON=function(e){return X.prototype.fromJSON.call(this,e)},e.toBBox=function(e){var t;if(e.bbox)t=e.bbox;else if(Array.isArray(e)&&4===e.length)t=e;else if(Array.isArray(e)&&6===e.length)t=[e[0],e[1],e[3],e[4]];else if("Feature"===e.type)t=Y(e);else{if("FeatureCollection"!==e.type)throw new Error("invalid geojson");t=Y(e)}return{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}},e}var C=oe;function ne(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);if(e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t)if(Object.setPrototypeOf)Object.setPrototypeOf(e,t);else for(var r=e,o=t,n=Object.getOwnPropertyNames(o),i=0;i<n.length;i++){var s=n[i],a=Object.getOwnPropertyDescriptor(o,s);a&&a.configurable&&void 0===r[s]&&Object.defineProperty(r,s,a)}}C.default=oe;var ie,se=o.INTERNAL_LAYER_PREFIX+"cxiaof_autoadsorb",B=(ne(A,ie=o.Class),A.prototype.setMode=function(e){return this.options.mode=e,this._updateGeosSet(),this},A.prototype.getMode=function(){return this.options.mode},A.prototype.setDistance=function(e){return this.options.distance=e,this._updateGeosSet(),this},A.prototype.getDistance=function(){return this.options.distance},A.prototype.isEnable=function(){return this._isEnable},A.prototype.bindDrawTool=function(e){return e instanceof o.DrawTool&&(this._map||this._addTo(e.getMap()),(this._drawTool=e).on("enable",this._enable,this),e.on("disable remove",this._disable,this),e.isEnabled()&&this._enable()),this},A.prototype.bindGeometry=function(e){return e instanceof o.Geometry&&(this._map||this._addTo(drawTool.getMap()),this._disableMapTool(),this._geometry=e,this._geometryCoords=e.getCoordinates(),e.on("editstart",this._enable,this),e.on("editend remove",this._disable,this),e.isEditing()&&this._enable()),this},A.prototype.remove=function(){this._disable(),this._cursorLayer&&this._cursorLayer.remove(),delete this._needDeal,delete this._treePoints,delete this._treeLines,delete this._cursorLayer,delete this._assistLayers,delete this._mousePoint,delete this._geosSetPoint,delete this._geosSetLine,delete this._cursor,delete this._adsorbPoint,delete this._drawTool,delete this._map},A.prototype._addTo=function(e){this._map=e,this._newCursorLayer(),this._saveAdsorbLayers()},A.prototype._newCursorLayer=function(){this._cursorLayer=new o.VectorLayer(se,{style:{symbol:this.options.cursorSymbol}}),this._cursorLayer.addTo(this._map).bringToFront()},A.prototype._saveAdsorbLayers=function(){var t=this;this._assistLayers=[],this.options.layers.forEach(function(e){(e="string"==typeof e?t._map.getLayer(e):e)instanceof o.VectorLayer&&t._assistLayers.push(e)})},A.prototype._enable=function(){this._isEnable=!0,this._cursorLayer&&this._cursorLayer.show(),this._updateGeosSet(),map.on("mousedown",this._mapMousedown,this),map.on("mouseup",this._mapMouseup,this),map.on("mousemove",this._mapMousemove,this)},A.prototype._mapMousedown=function(){this._needFindGeometry=!!this._geometry},A.prototype._mapMouseup=function(){this._needFindGeometry=!this._geometry},A.prototype._mapMousemove=function(e){var t=e.coordinate,e=e.domEvent;this._needDeal=!0,this._mousePoint=t,this._cursor?this._cursor.setCoordinates(t):(this._cursor=new o.Marker(t),this._cursor.addTo(this._cursorLayer)),delete this._adsorbPoint,this.options.needCtrl===e.ctrlKey&&this._updateAdsorbPoint(t)},A.prototype._updateAdsorbPoint=function(e){var t;this._needFindGeometry&&(0<(e=this._findGeometry(e)).length&&(this._adsorbPoint=this._getAdsorbPoint(e)),this._adsorbPoint&&(t=(e=this._adsorbPoint).x,e=e.y,this._cursor.setCoordinates([t,e])))},A.prototype._findGeometry=function(e){var t,r=[];return 0<this._geosSetPoint.length&&(t=this._findAvailGeos(this._treePoints,e),r=r.concat(t)),0<this._geosSetLine.length&&(t=this._findAvailGeos(this._treeLines,e),r=r.concat(t)),r},A.prototype._findAvailGeos=function(e,t){t=this._createInspectExtent(t);return e.search(t).features},A.prototype._createInspectExtent=function(e){var t=this._map.pixelToDistance(0,this.options.distance);return new o.Circle(e,t,{properties:{},numberOfShellPoints:this.options.shellPoints}).toGeoJSON()},A.prototype._getAdsorbPoint=function(e){var t=e.filter(function(e){return"Point"===e.geometry.type});if(0<t.length)return this._getNearestPoints(t);t=e.filter(function(e){return"LineString"===e.geometry.type});return this._getNearestPointsOnLine(t)},A.prototype._getNearestPoints=function(e){console.log("points",e.length)},A.prototype._getNearestPointsOnLine=function(e){console.log("lines",e.length)},A.prototype._updateGeosSet=function(){var e=this._getAllAssistGeos();["auto","vertux"].includes(this.options.mode)&&(this._geosSetPoint=this._parseToPoints(e)),["auto","border"].includes(this.options.mode)&&(this._geosSetLine=this._parseToLines(e)),this._updateRBushTree()},A.prototype._getAllAssistGeos=function(){return this._assistLayers.reduce(function(e,t){return e.concat(t.getGeometries())},[])},A.prototype._parseToPoints=function(e){var t=this,r=[];return e.forEach(function(e){r=(e instanceof o.GeometryCollection||(e instanceof o.Circle||e instanceof o.Ellipse)&&((e=e.copy()).setOptions(Object.assign(e.options||{},{numberOfShellPoints:t.options.shellPoints})),r.push(t._getCenterFeature(e))),r.concat(z(e.toGeoJSON()).features))}),r},A.prototype._getCenterFeature=function(e){return{type:"Feature",geometry:{type:"Point",coordinates:e.getCenter().toArray()},properties:{}}},A.prototype._parseToLines=function(e){var t=this,r=[];return(e=e.filter(function(e){return!(e instanceof o.Marker||e instanceof o.MultiPoint)})).forEach(function(e){e instanceof o.LineString?r.push(e.toGeoJSON()):r=e instanceof o.MultiLineString?r.concat(g(e.toGeoJSON()).features):((e instanceof o.Circle||e instanceof o.Ellipse)&&(e=e.copy()).setOptions(Object.assign(e.options||{},{numberOfShellPoints:t.options.shellPoints})),r.concat(t._polygonToLine(e.toGeoJSON())))}),this._splitLines(r)},A.prototype._polygonToLine=function(e){e=U(e);return"Feature"===e.type?g(e).features:e.features.reduce(function(e,t){return e.concat(g(t).features)},[])},A.prototype._splitLines=function(e){return e.reduce(function(e,t){for(var r=t.geometry.coordinates,o=0;o<r.length-1;o++){var n=[r[o],r[o+1]];e.push({type:"Feature",geometry:{type:"LineString",coordinates:n},properties:{}})}return e},[])},A.prototype._updateRBushTree=function(){this._treePoints.clear(),this._treePoints.load({type:"FeatureCollection",features:this._geosSetPoint}),this._treeLines.clear(),this._treeLines.load({type:"FeatureCollection",features:this._geosSetLine})},A.prototype._disable=function(){this._isEnable=!1,this._cursorLayer&&this._cursorLayer.hide(),map.off("mousedown",this._mapMousedown,this),map.off("mousemove",this._mapMousemove,this),map.off("mouseup",this._mapMouseup,this),this._resetGeosSet(),delete this._geometry,delete this._geometryCoords},A.prototype._resetGeosSet=function(){this._geosSetPoint=[],this._geosSetLine=[]},A.prototype._disableMapTool=function(){this._map._map_tool&&this._map._map_tool.disable()},A);function A(e){if(!(this instanceof A))throw new TypeError("Cannot call a class as a function");e=function(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(this,ie.call(this,e));return e._isEnable=!1,e._treePoints=C(),e._treeLines=C(),e}B.mergeOptions({layers:[],mode:"auto",distance:10,shellPoints:60,needCtrl:!1,cursorSymbol:{markerType:"ellipse",markerFill:"#de3333",markerWidth:4,markerHeight:4,markerLineWidth:0}}),e.Autoadsorb=B,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.autoadsorb v0.4.0, requires maptalks@>=0.46.0.")});