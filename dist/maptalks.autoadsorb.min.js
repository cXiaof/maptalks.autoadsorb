/*!
 * maptalks.autoadsorb v0.4.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
/*!
 * requires maptalks@>=0.46.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],t):t(e.maptalks=e.maptalks||{},e.maptalks)}(this,function(B,o){"use strict";var X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e=6371008.8,i={centimeters:100*e,centimetres:100*e,degrees:e/111325,feet:3.28084*e,inches:39.37*e,kilometers:e/1e3,kilometres:e/1e3,meters:e,metres:e,miles:e/1609.344,millimeters:1e3*e,millimetres:1e3*e,nauticalmiles:e/1852,radians:1,yards:1.0936*e},n={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046};function f(e,t,r){var o={type:"Feature"};return 0!==(r=void 0===r?{}:r).id&&!r.id||(o.id=r.id),r.bbox&&(o.bbox=r.bbox),o.properties=t||{},o.geometry=e,o}function d(e,t,r){if(void 0===r&&(r={}),!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(p(e[0])&&p(e[1]))return f({type:"Point",coordinates:e},t,r);throw new Error("coordinates must contain numbers")}function s(e,t,r){void 0===r&&(r={});for(var o=0,i=e;o<i.length;o++){var n=i[o];if(n.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var s=0;s<n[n.length-1].length;s++)if(n[n.length-1][s]!==n[0][s])throw new Error("First and last Position are not equivalent.")}return f({type:"Polygon",coordinates:e},t,r)}function y(e,t,r){if(void 0===r&&(r={}),e.length<2)throw new Error("coordinates must be an array of two or more positions");return f({type:"LineString",coordinates:e},t,r)}function m(e,t){var r={type:"FeatureCollection"};return(t=void 0===t?{}:t).id&&(r.id=t.id),t.bbox&&(r.bbox=t.bbox),r.features=e,r}function a(e,t,r){return f({type:"MultiLineString",coordinates:e},t,r=void 0===r?{}:r)}function Y(e,t,r){return f({type:"MultiPoint",coordinates:e},t,r=void 0===r?{}:r)}function N(e,t,r){return f({type:"MultiPolygon",coordinates:e},t,r=void 0===r?{}:r)}function u(e,t){var r=i[t=void 0===t?"kilometers":t];if(r)return e*r;throw new Error(t+" units is invalid")}function c(e,t){var r=i[t=void 0===t?"kilometers":t];if(r)return e/r;throw new Error(t+" units is invalid")}function l(e){return 180*(e%(2*Math.PI))/Math.PI}function h(e){return e%360*Math.PI/180}function p(e){return!isNaN(e)&&null!==e&&!Array.isArray(e)}function g(e){return!!e&&e.constructor===Object}e=Object.freeze({earthRadius:e,factors:i,unitsFactors:{centimeters:100,centimetres:100,degrees:1/111325,feet:3.28084,inches:39.37,kilometers:.001,kilometres:.001,meters:1,metres:1,miles:1/1609.344,millimeters:1e3,millimetres:1e3,nauticalmiles:1/1852,radians:1/e,yards:1.0936133},areaFactors:n,feature:f,geometry:function(e,t,r){switch(void 0===r&&(r={}),e){case"Point":return d(t).geometry;case"LineString":return y(t).geometry;case"Polygon":return s(t).geometry;case"MultiPoint":return Y(t).geometry;case"MultiLineString":return a(t).geometry;case"MultiPolygon":return N(t).geometry;default:throw new Error(e+" is invalid")}},point:d,points:function(e,t,r){return void 0===r&&(r={}),m(e.map(function(e){return d(e,t)}),r)},polygon:s,polygons:function(e,t,r){return void 0===r&&(r={}),m(e.map(function(e){return s(e,t)}),r)},lineString:y,lineStrings:function(e,t,r){return void 0===r&&(r={}),m(e.map(function(e){return y(e,t)}),r)},featureCollection:m,multiLineString:a,multiPoint:Y,multiPolygon:N,geometryCollection:function(e,t,r){return f({type:"GeometryCollection",geometries:e},t,r=void 0===r?{}:r)},round:function(e,t){if(!(t=void 0===t?0:t)||0<=t)return t=Math.pow(10,t||0),Math.round(e*t)/t;throw new Error("precision must be a positive number")},radiansToLength:u,lengthToRadians:c,lengthToDegrees:function(e,t){return l(c(e,t))},bearingToAzimuth:function(e){return(e%=360)<0&&(e+=360),e},radiansToDegrees:l,degreesToRadians:h,convertLength:function(e,t,r){if(void 0===t&&(t="kilometers"),void 0===r&&(r="kilometers"),0<=e)return u(c(e,t),r);throw new Error("length must be a positive number")},convertArea:function(e,t,r){if(void 0===t&&(t="meters"),void 0===r&&(r="kilometers"),!(0<=e))throw new Error("area must be a positive number");if(!(t=n[t]))throw new Error("invalid original units");if(r=n[r])return e/t*r;throw new Error("invalid final units")},isNumber:p,isObject:g,validateBBox:function(e){if(!e)throw new Error("bbox is required");if(!Array.isArray(e))throw new Error("bbox must be an Array");if(4!==e.length&&6!==e.length)throw new Error("bbox must be an Array of 4 or 6 numbers");e.forEach(function(e){if(!p(e))throw new Error("bbox must only contain numbers")})},validateId:function(e){if(!e)throw new Error("id is required");if(-1===["string","number"].indexOf(void 0===e?"undefined":X(e)))throw new Error("id must be a number or a string")}});function M(e,t,r){if(null!==e)for(var o,i,n,s=0,a=e.type,u="FeatureCollection"===a,c="Feature"===a,l=u?e.features.length:1,h=0;h<l;h++)for(var p,f,d=(f=!!(p=u?e.features[h].geometry:c?e.geometry:e)&&"GeometryCollection"===p.type)?p.geometries.length:1,y=0;y<d;y++){var m=0,g=0,_=f?p.geometries[y]:p;if(null!==_){var v=_.coordinates,b=_.type,w=!r||"Polygon"!==b&&"MultiPolygon"!==b?0:1;switch(b){case null:break;case"Point":if(!1===t(v,s,h,m,g))return!1;s++,m++;break;case"LineString":case"MultiPoint":for(o=0;o<v.length;o++){if(!1===t(v[o],s,h,m,g))return!1;s++,"MultiPoint"===b&&m++}"LineString"===b&&m++;break;case"Polygon":case"MultiLineString":for(o=0;o<v.length;o++){for(i=0;i<v[o].length-w;i++){if(!1===t(v[o][i],s,h,m,g))return!1;s++}"MultiLineString"===b&&m++,"Polygon"===b&&g++}"Polygon"===b&&m++;break;case"MultiPolygon":for(o=0;o<v.length;o++){for(i=g=0;i<v[o].length;i++){for(n=0;n<v[o][i].length-w;n++){if(!1===t(v[o][i][n],s,h,m,g))return!1;s++}g++}m++}break;case"GeometryCollection":for(o=0;o<_.geometries.length;o++)if(!1===M(_.geometries[o],t,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}function R(e,t){var r;switch(e.type){case"FeatureCollection":for(r=0;r<e.features.length&&!1!==t(e.features[r].properties,r);r++);break;case"Feature":t(e.properties,0)}}function _(e,t){if("Feature"===e.type)t(e,0);else if("FeatureCollection"===e.type)for(var r=0;r<e.features.length&&!1!==t(e.features[r],r);r++);}function t(e,t){for(var r,o,i,n,s,a,u,c,l,h=0,p="FeatureCollection"===e.type,f="Feature"===e.type,d=p?e.features.length:1,y=0;y<d;y++){for(s=p?e.features[y].geometry:f?e.geometry:e,u=p?e.features[y].properties:f?e.properties:{},c=p?e.features[y].bbox:f?e.bbox:void 0,l=p?e.features[y].id:f?e.id:void 0,n=(a=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,o=0;o<n;o++)if(null===(i=a?s.geometries[o]:s)){if(!1===t(null,h,u,c,l))return!1}else switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(i,h,u,c,l))return!1;break;case"GeometryCollection":for(r=0;r<i.geometries.length;r++)if(!1===t(i.geometries[r],h,u,c,l))return!1;break;default:throw new Error("Unknown Geometry Type")}h++}}function r(e,c){t(e,function(e,t,r,o,i){var n,s=null===e?null:e.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return!1===c(f(e,r,{bbox:o,id:i}),t,0)?!1:void 0}switch(s){case"MultiPoint":n="Point";break;case"MultiLineString":n="LineString";break;case"MultiPolygon":n="Polygon"}for(var a=0;a<e.coordinates.length;a++){var u=e.coordinates[a];if(!1===c(f({type:n,coordinates:u},r),t,a))return!1}})}function I(e,f){r(e,function(n,s,a){var u=0;if(n.geometry){var c,l,h,p,e=n.geometry.type;if("Point"!==e&&"MultiPoint"!==e)return p=h=l=0,!1!==M(n,function(e,t,r,o,i){return void 0===c||l<s||h<o||p<i?(c=e,l=s,h=o,p=i,void(u=0)):(o=y([c,e],n.properties),!1!==f(o,s,a,i,u)&&(u++,void(c=e)))})&&void 0}})}function D(e,s){if(!e)throw new Error("geojson is required");r(e,function(e,t,r){if(null!==e.geometry){var o=e.geometry.type,i=e.geometry.coordinates;switch(o){case"LineString":if(!1===s(e,t,r,0,0))return!1;break;case"Polygon":for(var n=0;n<i.length;n++)if(!1===s(y(i[n],e.properties),t,r,n))return!1}}})}var q=Object.freeze({coordAll:function(e){var t=[];return M(e,function(e){t.push(e)}),t},coordEach:M,coordReduce:function(e,n,s,t){var a=s;return M(e,function(e,t,r,o,i){a=0===t&&void 0===s?e:n(a,e,t,r,o,i)},t),a},featureEach:_,featureReduce:function(e,r,o){var i=o;return _(e,function(e,t){i=0===t&&void 0===o?e:r(i,e,t)}),i},findPoint:function(e,t){if(!g(t=t||{}))throw new Error("options is invalid");var r,o=t.featureIndex||0,i=t.multiFeatureIndex||0,n=t.geometryIndex||0,s=t.coordIndex||0,a=t.properties;switch(e.type){case"FeatureCollection":o<0&&(o=e.features.length+o),a=a||e.features[o].properties,r=e.features[o].geometry;break;case"Feature":a=a||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":return d(u,a,t);case"MultiPoint":return d(u[i=i<0?u.length+i:i],a,t);case"LineString":return d(u[s=s<0?u.length+s:s],a,t);case"Polygon":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s),d(u[n][s],a,t);case"MultiLineString":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s),d(u[i][s],a,t);case"MultiPolygon":return i<0&&(i=u.length+i),n<0&&(n=u[i].length+n),s<0&&(s=u[i][n].length-s),d(u[i][n][s],a,t)}throw new Error("geojson is invalid")},findSegment:function(e,t){if(!g(t=t||{}))throw new Error("options is invalid");var r,o=t.featureIndex||0,i=t.multiFeatureIndex||0,n=t.geometryIndex||0,s=t.segmentIndex||0,a=t.properties;switch(e.type){case"FeatureCollection":o<0&&(o=e.features.length+o),a=a||e.features[o].properties,r=e.features[o].geometry;break;case"Feature":a=a||e.properties,r=e.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=e;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":case"MultiPoint":return null;case"LineString":return y([u[s=s<0?u.length+s-1:s],u[s+1]],a,t);case"Polygon":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s-1),y([u[n][s],u[n][s+1]],a,t);case"MultiLineString":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s-1),y([u[i][s],u[i][s+1]],a,t);case"MultiPolygon":return i<0&&(i=u.length+i),n<0&&(n=u[i].length+n),s<0&&(s=u[i][n].length-s-1),y([u[i][n][s],u[i][n][s+1]],a,t)}throw new Error("geojson is invalid")},flattenEach:r,flattenReduce:function(e,o,i){var n=i;return r(e,function(e,t,r){n=0===t&&0===r&&void 0===i?e:o(n,e,t,r)}),n},geomEach:t,geomReduce:function(e,n,s){var a=s;return t(e,function(e,t,r,o,i){a=0===t&&void 0===s?e:n(a,e,t,r,o,i)}),a},lineEach:D,lineReduce:function(e,i,n){var s=n;return D(e,function(e,t,r,o){s=0===t&&void 0===n?e:i(s,e,t,r,o)}),s},propEach:R,propReduce:function(e,r,o){var i=o;return R(e,function(e,t){i=0===t&&void 0===o?e:r(i,e,t)}),i},segmentEach:I,segmentReduce:function(e,n,s){var a=s,u=!1;return I(e,function(e,t,r,o,i){a=!1===u&&void 0===s?e:n(a,e,t,r,o,i),u=!0}),a}});function J(t){var r=[];return"FeatureCollection"===t.type?_(t,function(t){M(t,function(e){r.push(d(e,t.properties))})}):M(t,function(e){r.push(d(e,t.properties))}),m(r)}function z(e){if(!e)throw new Error("geojson is required");var t=[];return r(e,function(e){t.push(e)}),m(t)}var H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function W(e){if(!e)throw new Error("geojson is required");switch(e.type){case"Feature":return U(e);case"FeatureCollection":return t=e,r={type:"FeatureCollection"},Object.keys(t).forEach(function(e){switch(e){case"type":case"features":return;default:r[e]=t[e]}}),r.features=t.features.map(U),r;case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return V(e);default:throw new Error("unknown GeoJSON type")}var t,r}function U(t){var r={type:"Feature"};return Object.keys(t).forEach(function(e){switch(e){case"type":case"properties":case"geometry":return;default:r[e]=t[e]}}),r.properties=function r(o){var i={};if(!o)return i;Object.keys(o).forEach(function(e){var t=o[e];"object"===(void 0===t?"undefined":H(t))?null===t?i[e]=null:Array.isArray(t)?i[e]=t.map(function(e){return e}):i[e]=r(t):i[e]=t});return i}(t.properties),r.geometry=V(t.geometry),r}function V(e){var t={type:e.type};return e.bbox&&(t.bbox=e.bbox),"GeometryCollection"===e.type?t.geometries=e.geometries.map(V):t.coordinates=function t(e){if("object"!==H(e[0]))return e.slice();return e.map(function(e){return t(e)})}(e.coordinates),t}function v(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if("Feature"===e.type&&null!==e.geometry&&"Point"===e.geometry.type)return e.geometry.coordinates;if("Point"===e.type)return e.coordinates}if(Array.isArray(e)&&2<=e.length&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return e;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function b(e){if(Array.isArray(e))return e;if("Feature"===e.type){if(null!==e.geometry)return e.geometry.coordinates}else if(e.coordinates)return e.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function K(e){return"Feature"===e.type?e.geometry:e}function w(e,t,r){void 0===r&&(r={});var e=v(e),t=v(t),o=h(t[1]-e[1]),i=h(t[0]-e[0]),e=h(e[1]),t=h(t[1]),o=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(i/2),2)*Math.cos(e)*Math.cos(t);return u(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),r.units)}function Q(e,t,r){if(!0===(r=void 0===r?{}:r).final)return(Q(t,e)+180)%360;var r=v(e),e=v(t),t=h(r[0]),o=h(e[0]),r=h(r[1]),e=h(e[1]),i=Math.sin(o-t)*Math.cos(e),r=Math.cos(r)*Math.sin(e)-Math.sin(r)*Math.cos(e)*Math.cos(o-t);return l(Math.atan2(i,r))}function Z(e,t,r,o){void 0===o&&(o={});var e=v(e),i=h(e[0]),e=h(e[1]),r=h(r),t=c(t,o.units),n=Math.asin(Math.sin(e)*Math.cos(t)+Math.cos(e)*Math.sin(t)*Math.cos(r));return d([l(i+Math.atan2(Math.sin(r)*Math.sin(t)*Math.cos(e),Math.cos(t)-Math.sin(e)*Math.sin(n))),l(n)],o.properties)}function $(e){if(!e)throw new Error("geojson is required");var n=[];return r(e,function(e){var t=e,r=n,o=[],i=t.geometry;if(null!==i){switch(i.type){case"Polygon":o=b(i);break;case"LineString":o=[b(i)]}o.forEach(function(e){var s,a;s=t.properties,a=[],e.reduce(function(e,t){var r,o,i,n=y([e,t],s);return n.bbox=(r=t,o=(e=e)[0],e=e[1],i=r[0],r=r[1],[o<i?o:i,e<r?e:r,i<o?o:i,r<e?e:r]),a.push(n),t}),a.forEach(function(e){e.id=r.length,r.push(e)})})}}),m(n)}function ee(e,t,r,o,i){!function e(t,r,o,i,n){for(;o<i;){600<i-o&&(s=i-o+1,l=r-o+1,u=Math.log(s),a=.5*Math.exp(2*u/3),u=.5*Math.sqrt(u*a*(s-a)/s)*(l-s/2<0?-1:1),c=Math.max(o,Math.floor(r-l*a/s+u)),l=Math.min(i,Math.floor(r+(s-l)*a/s+u)),e(t,r,c,l,n));var s,a,u,c,l,h=t[r],p=o,f=i;for(P(t,o,r),0<n(t[i],h)&&P(t,o,i);p<f;){for(P(t,p,f),p++,f--;n(t[p],h)<0;)p++;for(;0<n(t[f],h);)f--}0===n(t[o],h)?P(t,o,f):P(t,++f,i),f<=r&&(o=f+1),r<=f&&(i=f-1)}}(e,t,r||0,o||e.length-1,i||te)}function P(e,t,r){var o=e[t];e[t]=e[r],e[r]=o}function te(e,t){return e<t?-1:t<e?1:0}x.prototype.all=function(){return this._all(this.data,[])},x.prototype.search=function(e){var t=this.data,r=[];if(!k(e,t))return r;for(var o=this.toBBox,i=[];t;){for(var n=0;n<t.children.length;n++){var s=t.children[n],a=t.leaf?o(s):s;k(e,a)&&(t.leaf?r.push(s):se(e,a)?this._all(s,r):i.push(s))}t=i.pop()}return r},x.prototype.collides=function(e){var t=this.data;if(!k(e,t))return!1;for(var r=[];t;){for(var o=0;o<t.children.length;o++){var i=t.children[o],n=t.leaf?this.toBBox(i):i;if(k(e,n)){if(t.leaf||se(e,n))return!0;r.push(i)}}t=r.pop()}return!1},x.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0;t<e.length;t++)this.insert(e[t]);return this}var r,o=this._build(e.slice(),0,e.length-1,0);return this.data.children.length?this.data.height===o.height?this._splitRoot(this.data,o):(this.data.height<o.height&&(r=this.data,this.data=o,o=r),this._insert(o,this.data.height-o.height-1,!0)):this.data=o,this},x.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},x.prototype.clear=function(){return this.data=F([]),this},x.prototype.remove=function(e,t){if(!e)return this;for(var r=this.data,o=this.toBBox(e),i=[],n=[],s=void 0,a=void 0,u=void 0;r||i.length;){if(r||(r=i.pop(),a=i[i.length-1],s=n.pop(),u=!0),r.leaf){var c=function(e,t,r){if(!r)return t.indexOf(e);for(var o=0;o<t.length;o++)if(r(e,t[o]))return o;return-1}(e,r.children,t);if(-1!==c)return r.children.splice(c,1),i.push(r),this._condense(i),this}u||r.leaf||!se(r,o)?a?(s++,r=a.children[s],u=!1):r=null:(i.push(r),n.push(s),r=(a=r).children[s=0])}return this},x.prototype.toBBox=function(e){return e},x.prototype.compareMinX=function(e,t){return e.minX-t.minX},x.prototype.compareMinY=function(e,t){return e.minY-t.minY},x.prototype.toJSON=function(){return this.data},x.prototype.fromJSON=function(e){return this.data=e,this},x.prototype._all=function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},x.prototype._build=function(e,t,r,o){var i=r-t+1,n=this._maxEntries,s=void 0;if(i<=n)return S(s=F(e.slice(t,r+1)),this.toBBox),s;o||(o=Math.ceil(Math.log(i)/Math.log(n)),n=Math.ceil(i/Math.pow(n,o-1))),(s=F([])).leaf=!1,s.height=o;var a=Math.ceil(i/n),u=a*Math.ceil(Math.sqrt(n));ae(e,t,r,u,this.compareMinX);for(var c=t;c<=r;c+=u){var l=Math.min(c+u-1,r);ae(e,c,l,a,this.compareMinY);for(var h=c;h<=l;h+=a){var p=Math.min(h+a-1,l);s.children.push(this._build(e,h,p,o-1))}}return S(s,this.toBBox),s},x.prototype._chooseSubtree=function(e,t,r,o){for(;;){if(o.push(t),t.leaf||o.length-1===r)break;for(var i=1/0,n=1/0,s=void 0,a=0;a<t.children.length;a++){var u=t.children[a],c=ne(u),l=(h=e,l=u,(Math.max(l.maxX,h.maxX)-Math.min(l.minX,h.minX))*(Math.max(l.maxY,h.maxY)-Math.min(l.minY,h.minY))-c);l<n?(n=l,i=c<i?c:i,s=u):l===n&&c<i&&(i=c,s=u)}t=s||t.children[0]}var h,l;return t},x.prototype._insert=function(e,t,r){var r=r?e:this.toBBox(e),o=[],i=this._chooseSubtree(r,this.data,t,o);for(i.children.push(e),L(i,r);0<=t&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(r,o,t)},x.prototype._split=function(e,t){var r=e[t],o=r.children.length,i=this._minEntries,i=(this._chooseSplitAxis(r,i,o),this._chooseSplitIndex(r,i,o)),o=F(r.children.splice(i,r.children.length-i));o.height=r.height,o.leaf=r.leaf,S(r,this.toBBox),S(o,this.toBBox),t?e[t-1].children.push(o):this._splitRoot(r,o)},x.prototype._splitRoot=function(e,t){this.data=F([e,t]),this.data.height=e.height+1,this.data.leaf=!1,S(this.data,this.toBBox)},x.prototype._chooseSplitIndex=function(e,t,r){for(var o,i,n,s=void 0,a=1/0,u=1/0,c=t;c<=r-t;c++){var l=E(e,0,c,this.toBBox),h=E(e,c,r,this.toBBox),p=(o=l,p=h,f=n=i=void 0,i=Math.max(o.minX,p.minX),n=Math.max(o.minY,p.minY),f=Math.min(o.maxX,p.maxX),o=Math.min(o.maxY,p.maxY),Math.max(0,f-i)*Math.max(0,o-n)),f=ne(l)+ne(h);p<a?(a=p,s=c,u=f<u?f:u):p===a&&f<u&&(u=f,s=c)}return s||r-t},x.prototype._chooseSplitAxis=function(e,t,r){var o=e.leaf?this.compareMinX:oe,i=e.leaf?this.compareMinY:ie;this._allDistMargin(e,t,r,o)<this._allDistMargin(e,t,r,i)&&e.children.sort(o)},x.prototype._allDistMargin=function(e,t,r,o){e.children.sort(o);for(var i=this.toBBox,n=E(e,0,t,i),s=E(e,r-t,r,i),a=C(n)+C(s),u=t;u<r-t;u++){var c=e.children[u];L(n,e.leaf?i(c):c),a+=C(n)}for(var l=r-t-1;t<=l;l--){var h=e.children[l];L(s,e.leaf?i(h):h),a+=C(s)}return a},x.prototype._adjustParentBBoxes=function(e,t,r){for(var o=r;0<=o;o--)L(t[o],e)},x.prototype._condense=function(e){for(var t,r=e.length-1;0<=r;r--)0===e[r].children.length?0<r?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():S(e[r],this.toBBox)};var re=x;function x(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:9,t=this,r=x;if(!(t instanceof r))throw new TypeError("Cannot call a class as a function");this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}function S(e,t){E(e,0,e.children.length,t,e)}function E(e,t,r,o,i){(i=i||F(null)).minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var n=t;n<r;n++){var s=e.children[n];L(i,e.leaf?o(s):s)}return i}function L(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function oe(e,t){return e.minX-t.minX}function ie(e,t){return e.minY-t.minY}function ne(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function C(e){return e.maxX-e.minX+(e.maxY-e.minY)}function se(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function k(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function F(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ae(e,t,r,o,i){for(var n,s=[t,r];s.length;)(r=s.pop())-(t=s.pop())<=o||(ee(e,n=t+Math.ceil((r-t)/o/2)*o,t,r,i),s.push(t,n,n,r))}var ue=Object.freeze({default:re});function A(e){var t=[1/0,1/0,-1/0,-1/0];return M(e,function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])}),t}A.default=A;var ce=Object.freeze({default:A}),O=ue&&re,T=(ce&&A).default,le=q.featureEach,he=e.featureCollection;function pe(e){e=new O(e);return e.insert=function(e){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox||T(e),O.prototype.insert.call(this,e)},e.load=function(e){var t=[];return Array.isArray(e)?e.forEach(function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox||T(e),t.push(e)}):le(e,function(e){if("Feature"!==e.type)throw new Error("invalid features");e.bbox=e.bbox||T(e),t.push(e)}),O.prototype.load.call(this,t)},e.remove=function(e,t){if("Feature"!==e.type)throw new Error("invalid feature");return e.bbox=e.bbox||T(e),O.prototype.remove.call(this,e,t)},e.clear=function(){return O.prototype.clear.call(this)},e.search=function(e){e=O.prototype.search.call(this,this.toBBox(e));return he(e)},e.collides=function(e){return O.prototype.collides.call(this,this.toBBox(e))},e.all=function(){var e=O.prototype.all.call(this);return he(e)},e.toJSON=function(){return O.prototype.toJSON.call(this)},e.fromJSON=function(e){return O.prototype.fromJSON.call(this,e)},e.toBBox=function(e){var t;if(e.bbox)t=e.bbox;else if(Array.isArray(e)&&4===e.length)t=e;else if(Array.isArray(e)&&6===e.length)t=[e[0],e[1],e[3],e[4]];else if("Feature"===e.type)t=T(e);else{if("FeatureCollection"!==e.type)throw new Error("invalid geojson");t=T(e)}return{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}},e}var G=pe;function fe(e,t){e=b(e),t=b(t);if(2!==e.length)throw new Error("<intersects> line1 must only contain 2 coordinates");if(2!==t.length)throw new Error("<intersects> line2 must only contain 2 coordinates");var r=e[0][0],o=e[0][1],i=e[1][0],e=e[1][1],n=t[0][0],s=t[0][1],a=t[1][0],t=t[1][1],u=(t-s)*(i-r)-(a-n)*(e-o),a=(a-n)*(o-s)-(t-s)*(r-n),t=(i-r)*(o-s)-(e-o)*(r-n);if(0==u)return null;s=a/u,n=t/u;return 0<=s&&s<=1&&0<=n&&n<=1?d([r+s*(i-r),o+s*(e-o)]):null}function de(e,c,l){void 0===l&&(l={});var h=d([1/0,1/0],{dist:1/0}),p=0;return r(e,function(e){for(var t=b(e),r=0;r<t.length-1;r++){var o=d(t[r]),i=(o.properties.dist=w(c,o,l),d(t[r+1])),n=(i.properties.dist=w(c,i,l),w(o,i,l)),s=Math.max(o.properties.dist,i.properties.dist),a=Q(o,i),u=Z(c,s,a+90,l),s=Z(c,s,a-90,l),a=function(e,t){var r,o={},i=[];if("LineString"===e.type&&(e=f(e)),"LineString"===t.type&&(t=f(t)),"Feature"===e.type&&"Feature"===t.type&&null!==e.geometry&&null!==t.geometry&&"LineString"===e.geometry.type&&"LineString"===t.geometry.type&&2===e.geometry.coordinates.length&&2===t.geometry.coordinates.length)return(r=fe(e,t))&&i.push(r),m(i);var n=G();return n.load($(t)),_($(e),function(r){_(n.search(r),function(e){var t,e=fe(r,e);e&&(t=b(e).join(","),o[t]||(o[t]=!0,i.push(e)))})}),m(i)}(y([u.geometry.coordinates,s.geometry.coordinates]),y([o.geometry.coordinates,i.geometry.coordinates])),u=null;0<a.features.length&&((u=a.features[0]).properties.dist=w(c,u,l),u.properties.location=p+w(o,u,l)),o.properties.dist<h.properties.dist&&((h=o).properties.index=r,h.properties.location=p),i.properties.dist<h.properties.dist&&((h=i).properties.index=r+1,h.properties.location=p+n),u&&u.properties.dist<h.properties.dist&&((h=u).properties.index=r),p+=n}}),h}G.default=pe;function ye(e,t){void 0===t&&(t={});var r,o,i,n,s,a=K(e);switch(t.properties||"Feature"!==e.type||(t.properties=e.properties),a.type){case"Polygon":return void 0===(n=t)&&(n={}),s=K(i=a).coordinates,n=n.properties||("Feature"===i.type?i.properties:{}),me(s,n);case"MultiPolygon":return void 0===(i=t)&&(i={}),n=K(s=a).coordinates,r=i.properties||("Feature"===s.type?s.properties:{}),o=[],n.forEach(function(e){o.push(me(e,r))}),m(o);default:throw new Error("invalid poly")}}function me(e,t){return 1<e.length?a(e,t):y(e[0],t)}function ge(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);if(e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t)if(Object.setPrototypeOf)Object.setPrototypeOf(e,t);else for(var r=e,o=t,i=Object.getOwnPropertyNames(o),n=0;n<i.length;n++){var s=i[n],a=Object.getOwnPropertyDescriptor(o,s);a&&a.configurable&&void 0===r[s]&&Object.defineProperty(r,s,a)}}var _e,ve=o.INTERNAL_LAYER_PREFIX+"cxiaof_autoadsorb",ue=(ge(j,_e=o.Class),j.prototype.setMode=function(e){return this.options.mode=e,this._updateGeosSet(),this},j.prototype.getMode=function(){return this.options.mode},j.prototype.setDistance=function(e){return this.options.distance=e,this._updateGeosSet(),this},j.prototype.getDistance=function(){return this.options.distance},j.prototype.refreshTargets=function(){return this._updateGeosSet(),this},j.prototype.isEnable=function(){return this._isEnable},j.prototype.bindDrawTool=function(e){return e instanceof o.DrawTool&&(this._map||this._addTo(e.getMap()),(this._drawTool=e).on("enable",this._enable,this),e.on("disable remove",this._disable,this),e.isEnabled()&&this._enable()),this},j.prototype.bindGeometry=function(e){return e instanceof o.Geometry&&(this._map||this._addTo(drawTool.getMap()),this._disableMapTool(),(this._geometry=e).on("editstart",this._enable,this),e.on("editend remove",this._disable,this),e.isEditing()&&this._enable()),this},j.prototype.remove=function(){this._disable(),this._cursorLayer&&this._cursorLayer.remove(),delete this._needDeal,delete this._treePoints,delete this._treeLines,delete this._cursorLayer,delete this._assistLayers,delete this._mousePoint,delete this._geosSetPoint,delete this._geosSetLine,delete this._cursor,delete this._adsorbPoint,delete this._drawTool,delete this._map},j.prototype._addTo=function(e){this._map=e,this._newCursorLayer(),this._saveAdsorbLayers()},j.prototype._newCursorLayer=function(){this._cursorLayer=new o.VectorLayer(ve,{style:{symbol:this._getCursorSymbol()}}),this._cursorLayer.addTo(this._map).bringToFront()},j.prototype._getCursorSymbol=function(e){return Object.assign({markerType:"ellipse",markerFill:"#fff",markerLineColor:"#272822",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:.4},e)},j.prototype._saveAdsorbLayers=function(){var t=this;this._assistLayers=[],this.options.layers.forEach(function(e){(e="string"==typeof e?t._map.getLayer(e):e)instanceof o.VectorLayer&&t._assistLayers.push(e)})},j.prototype._enable=function(){this._isEnable=!0,this._cursorLayer&&this._cursorLayer.show(),this._updateGeosSet(),this._registerMapEvents(),this._geometry?this._registerGeometryEvents():this._registerDrawToolEvents()},j.prototype._updateGeosSet=function(){this._geosSetPoint=[],this._geosSetLine=[];var e=this._getAllAssistGeos();["auto","vertux"].includes(this.options.mode)&&(this._geosSetPoint=this._parseToPoints(e)),["auto","border"].includes(this.options.mode)&&(this._geosSetLine=this._parseToLines(e)),this._updateRBushTree()},j.prototype._getAllAssistGeos=function(){return this._assistLayers.reduce(function(e,t){return e.concat(t.getGeometries())},[])},j.prototype._parseToPoints=function(e){var t=this,r=[];return e.forEach(function(e){r=(e instanceof o.GeometryCollection||(e instanceof o.Circle||e instanceof o.Ellipse)&&((e=e.copy()).setOptions(Object.assign(e.options||{},{numberOfShellPoints:t.options.shellPoints})),r.push(t._getCenterFeature(e))),r.concat(J(e.toGeoJSON()).features))}),r},j.prototype._getCenterFeature=function(e){return{type:"Feature",geometry:{type:"Point",coordinates:e.getCenter().toArray()},properties:{}}},j.prototype._parseToLines=function(e){var t=this,r=[];return(e=e.filter(function(e){return!(e instanceof o.Marker||e instanceof o.MultiPoint)})).forEach(function(e){e instanceof o.LineString?r.push(e.toGeoJSON()):r=e instanceof o.MultiLineString?r.concat(z(e.toGeoJSON()).features):((e instanceof o.Circle||e instanceof o.Ellipse)&&(e=e.copy()).setOptions(Object.assign(e.options||{},{numberOfShellPoints:t.options.shellPoints})),r.concat(t._polygonToLine(e.toGeoJSON())))}),this._splitLines(r)},j.prototype._polygonToLine=function(e){e=ye(e);return"Feature"===e.type?z(e).features:e.features.reduce(function(e,t){return e.concat(z(t).features)},[])},j.prototype._splitLines=function(e){return e.reduce(function(e,t){for(var r=t.geometry.coordinates,o=0;o<r.length-1;o++){var i=[r[o],r[o+1]];e.push({type:"Feature",geometry:{type:"LineString",coordinates:i},properties:{}})}return e},[])},j.prototype._updateRBushTree=function(){this._treePoints.clear(),this._treePoints.load({type:"FeatureCollection",features:this._geosSetPoint}),this._treeLines.clear(),this._treeLines.load({type:"FeatureCollection",features:this._geosSetLine})},j.prototype._registerMapEvents=function(){this._needFindGeometry=!this._geometry,this._map.on("mousedown",this._mapMousedown,this),this._map.on("mouseup",this._mapMouseup,this),this._map.on("mousemove",this._mapMousemove,this)},j.prototype._mapMousedown=function(){this._geometry&&(this._needFindGeometry=!0)},j.prototype._mapMouseup=function(){this._geometry&&(this._needFindGeometry=!1)},j.prototype._mapMousemove=function(e){var t=e.coordinate,e=e.domEvent;this._needDeal=!0,this._mousePoint=t,this._cursor?this._cursor.setCoordinates(t):(this._cursor=new o.Marker(t),this._cursor.addTo(this._cursorLayer)),delete this._adsorbPoint,this.options.needCtrl===e.ctrlKey&&this._updateAdsorbPoint(t)},j.prototype._updateAdsorbPoint=function(e){var t;this._needFindGeometry&&(0<(e=this._findGeometry(e)).length&&(this._adsorbPoint=this._getAdsorbPoint(e)),this._adsorbPoint?(t=(e=this._adsorbPoint).x,e=e.y,this._cursor.setCoordinates([t,e])):this._cursor.setSymbol(this._getCursorSymbol()))},j.prototype._findGeometry=function(e){var t,r=[];return 0<this._geosSetPoint.length&&(t=this._findAvailGeos(this._treePoints,e),r=r.concat(t)),0<this._geosSetLine.length&&(t=this._findAvailGeos(this._treeLines,e),r=r.concat(t)),r},j.prototype._findAvailGeos=function(e,t){t=this._createInspectExtent(t);return e.search(t).features},j.prototype._createInspectExtent=function(e){var t=this._map.pixelToDistance(0,this.options.distance);return new o.Circle(e,t,{properties:{},numberOfShellPoints:this.options.shellPoints}).toGeoJSON()},j.prototype._getAdsorbPoint=function(e){var t=void 0,r=[this._mousePoint.x,this._mousePoint.y],o=e.filter(function(e){return"Point"===e.geometry.type}),e=(0<o.length?(t=this._getNearestPoint(r,o),this._cursor.setSymbol(this._getCursorSymbol({markerFill:"#f5871f",markerLineColor:"#0078a8",opacity:1}))):(o=e.filter(function(e){return"LineString"===e.geometry.type}),t=this._getNearestPointOnLine(r,o),this._cursor.setSymbol(this._getCursorSymbol({markerLineColor:"#0078a8",opacity:1}))),t.geometry.coordinates);return{x:e[0],y:e[1]}},j.prototype._getNearestPoint=function(e,t){var r=e,e={type:"FeatureCollection",features:t};if(!r)throw new Error("targetPoint is required");if(!e)throw new Error("points is required");var o=1/0,i=0;return _(e,function(e,t){e=w(r,e);e<o&&(i=t,o=e)}),(e=W(e.features[i])).properties.featureIndex=i,e.properties.distanceToPoint=o,e},j.prototype._getNearestPointOnLine=function(e,t){var o;return o={MultiPoint:{coordinates:[],properties:[]},MultiLineString:{coordinates:[],properties:[]},MultiPolygon:{coordinates:[],properties:[]}},_({type:"FeatureCollection",features:t},function(e){var t,r;switch(null==(r=e.geometry)?void 0:r.type){case"Point":o.MultiPoint.coordinates.push(e.geometry.coordinates),o.MultiPoint.properties.push(e.properties);break;case"MultiPoint":(t=o.MultiPoint.coordinates).push.apply(t,e.geometry.coordinates),o.MultiPoint.properties.push(e.properties);break;case"LineString":o.MultiLineString.coordinates.push(e.geometry.coordinates),o.MultiLineString.properties.push(e.properties);break;case"MultiLineString":(t=o.MultiLineString.coordinates).push.apply(t,e.geometry.coordinates),o.MultiLineString.properties.push(e.properties);break;case"Polygon":o.MultiPolygon.coordinates.push(e.geometry.coordinates),o.MultiPolygon.properties.push(e.properties);break;case"MultiPolygon":(t=o.MultiPolygon.coordinates).push.apply(t,e.geometry.coordinates),o.MultiPolygon.properties.push(e.properties)}}),de(m(Object.keys(o).filter(function(e){return o[e].coordinates.length}).sort().map(function(e){return f({type:e,coordinates:o[e].coordinates},{collectedProperties:o[e].properties})})),e)},j.prototype._registerGeometryEvents=function(){this._geometry.on("handledragend",this._checkCenter,this),this._geometry.on("shapechange",this._setShadowCoordinates,this),this._geometry.on("editrecord",this._resetShadowCenter,this)},j.prototype._checkCenter=function(){this._dragCenterHandle=this._shapechange,delete this._shapechange},j.prototype._setShadowCoordinates=function(e){this._shapechange=!0,this._needDeal&&this._adsorbPoint&&e.target},j.prototype._resetShadowCenter=function(e){var t,r;this._adsorbPoint&&((e=e.target)instanceof o.Marker?e.setCoordinates(this._adsorbPoint):this._dragCenterHandle&&(t=e.getCenter(),r=[(r=this._adsorbPoint).x-t.x,r.y-t.y],e.translate.apply(e,r),(t=e._editor._shadow).translate.apply(t,r)))},j.prototype._registerDrawToolEvents=function(){this._drawTool.on("drawstart drawvertex",this._resetCoordsAndPoint,this),this._drawTool.on("mousemove drawend",this._resetCoordinates,this)},j.prototype._resetCoordsAndPoint=function(e){this._resetCoordinates(e),this._resetClickPoint(e)},j.prototype._resetCoordinates=function(e){if(this._adsorbPoint){var t=e.target,r=t.options.mode,o=t._geometry,i=o.getCoordinates(),t=this._adsorbPoint,n=t.x,s=t.y;switch(r){case"Point":o.setCoordinates(this._adsorbPoint);break;case"Rectangle":0===i[0].length?(a=this._map.coordinateToPoint(this._adsorbPoint),e.geometry._firstClick=this._map._pointToPrj(a)):(i[0][1].x=n,i[0][2].x=n,i[0][2].y=s,i[0][3].y=s,o.setCoordinates(i));break;case"Circle":if("drawstart"===e.type)return void o.setCoordinates(this._adsorbPoint);var a=this._map.getProjection().measureLength([i,this._adsorbPoint]);o.setRadius(a);break;case"Ellipse":if("drawstart"===e.type)return void o.setCoordinates(this._adsorbPoint);var a=this._map.getProjection().measureLength([i,{x:n,y:i.y}]),u=this._map.getProjection().measureLength([i,{x:i.x,y:s}]);o.setWidth(2*a).setHeight(2*u)._updateCache();break;default:i.pop(),i.push(this._adsorbPoint),o.setCoordinates(i)}}},j.prototype._resetClickPoint=function(e){var t;this._adsorbPoint&&(e=e.target._clickCoords,t=this._map.coordToPoint(this._adsorbPoint),e.pop(),e.push(this._map._pointToPrj(t)))},j.prototype._disable=function(){this._isEnable=!1,this._cursorLayer&&this._cursorLayer.hide(),this._offMapEvents(),this._geometry?this._offGeometryEvents():this._offDrawToolEvents(),this._resetGeosSet(),delete this._geometry},j.prototype._offMapEvents=function(){delete this._needFindGeometry,this._map.off("mousedown",this._mapMousedown,this),this._map.off("mousemove",this._mapMousemove,this),this._map.off("mouseup",this._mapMouseup,this)},j.prototype._offGeometryEvents=function(){this._geometry.off("shapechange",this._setShadowCoordinates,this),this._geometry.off("editrecord",this._resetShadowCenter,this)},j.prototype._offDrawToolEvents=function(){this._drawTool.off("drawstart drawvertex",this._resetCoordsAndPoint,this),this._drawTool.off("mousemove drawend",this._resetCoordinates,this)},j.prototype._resetGeosSet=function(){this._geosSetPoint=[],this._geosSetLine=[]},j.prototype._disableMapTool=function(){this._map._map_tool&&this._map._map_tool.disable()},j);function j(e){if(!(this instanceof j))throw new TypeError("Cannot call a class as a function");e=function(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(this,_e.call(this,e));return e._isEnable=!1,e._treePoints=G(),e._treeLines=G(),e}ue.mergeOptions({layers:[],mode:"auto",distance:10,shellPoints:60,needCtrl:!1}),B.Autoadsorb=ue,Object.defineProperty(B,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.autoadsorb v0.4.0, requires maptalks@>=0.46.0.")});