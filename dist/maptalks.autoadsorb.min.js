/*!
 * maptalks.autoadsorb v0.4.0
 * LICENSE : MIT
 * (c) 2016-2022 maptalks.org
 */
/*!
 * requires maptalks@>=0.46.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(j,o){"use strict";var X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t=6371008.8,i={centimeters:100*t,centimetres:100*t,degrees:t/111325,feet:3.28084*t,inches:39.37*t,kilometers:t/1e3,kilometres:t/1e3,meters:t,metres:t,miles:t/1609.344,millimeters:1e3*t,millimetres:1e3*t,nauticalmiles:t/1852,radians:1,yards:1.0936*t},n={acres:247105e-9,centimeters:1e4,centimetres:1e4,feet:10.763910417,hectares:1e-4,inches:1550.003100006,kilometers:1e-6,kilometres:1e-6,meters:1,metres:1,miles:386e-9,millimeters:1e6,millimetres:1e6,yards:1.195990046};function f(t,e,r){var o={type:"Feature"};return 0!==(r=void 0===r?{}:r).id&&!r.id||(o.id=r.id),r.bbox&&(o.bbox=r.bbox),o.properties=e||{},o.geometry=t,o}function d(t,e,r){if(void 0===r&&(r={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(p(t[0])&&p(t[1]))return f({type:"Point",coordinates:t},e,r);throw new Error("coordinates must contain numbers")}function s(t,e,r){void 0===r&&(r={});for(var o=0,i=t;o<i.length;o++){var n=i[o];if(n.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var s=0;s<n[n.length-1].length;s++)if(n[n.length-1][s]!==n[0][s])throw new Error("First and last Position are not equivalent.")}return f({type:"Polygon",coordinates:t},e,r)}function y(t,e,r){if(void 0===r&&(r={}),t.length<2)throw new Error("coordinates must be an array of two or more positions");return f({type:"LineString",coordinates:t},e,r)}function m(t,e){var r={type:"FeatureCollection"};return(e=void 0===e?{}:e).id&&(r.id=e.id),e.bbox&&(r.bbox=e.bbox),r.features=t,r}function a(t,e,r){return f({type:"MultiLineString",coordinates:t},e,r=void 0===r?{}:r)}function Y(t,e,r){return f({type:"MultiPoint",coordinates:t},e,r=void 0===r?{}:r)}function N(t,e,r){return f({type:"MultiPolygon",coordinates:t},e,r=void 0===r?{}:r)}function u(t,e){var r=i[e=void 0===e?"kilometers":e];if(r)return t*r;throw new Error(e+" units is invalid")}function c(t,e){var r=i[e=void 0===e?"kilometers":e];if(r)return t/r;throw new Error(e+" units is invalid")}function l(t){return 180*(t%(2*Math.PI))/Math.PI}function h(t){return t%360*Math.PI/180}function p(t){return!isNaN(t)&&null!==t&&!Array.isArray(t)}function g(t){return!!t&&t.constructor===Object}t=Object.freeze({earthRadius:t,factors:i,unitsFactors:{centimeters:100,centimetres:100,degrees:1/111325,feet:3.28084,inches:39.37,kilometers:.001,kilometres:.001,meters:1,metres:1,miles:1/1609.344,millimeters:1e3,millimetres:1e3,nauticalmiles:1/1852,radians:1/t,yards:1.0936133},areaFactors:n,feature:f,geometry:function(t,e,r){switch(void 0===r&&(r={}),t){case"Point":return d(e).geometry;case"LineString":return y(e).geometry;case"Polygon":return s(e).geometry;case"MultiPoint":return Y(e).geometry;case"MultiLineString":return a(e).geometry;case"MultiPolygon":return N(e).geometry;default:throw new Error(t+" is invalid")}},point:d,points:function(t,e,r){return void 0===r&&(r={}),m(t.map(function(t){return d(t,e)}),r)},polygon:s,polygons:function(t,e,r){return void 0===r&&(r={}),m(t.map(function(t){return s(t,e)}),r)},lineString:y,lineStrings:function(t,e,r){return void 0===r&&(r={}),m(t.map(function(t){return y(t,e)}),r)},featureCollection:m,multiLineString:a,multiPoint:Y,multiPolygon:N,geometryCollection:function(t,e,r){return f({type:"GeometryCollection",geometries:t},e,r=void 0===r?{}:r)},round:function(t,e){if(!(e=void 0===e?0:e)||0<=e)return e=Math.pow(10,e||0),Math.round(t*e)/e;throw new Error("precision must be a positive number")},radiansToLength:u,lengthToRadians:c,lengthToDegrees:function(t,e){return l(c(t,e))},bearingToAzimuth:function(t){return(t%=360)<0&&(t+=360),t},radiansToDegrees:l,degreesToRadians:h,convertLength:function(t,e,r){if(void 0===e&&(e="kilometers"),void 0===r&&(r="kilometers"),0<=t)return u(c(t,e),r);throw new Error("length must be a positive number")},convertArea:function(t,e,r){if(void 0===e&&(e="meters"),void 0===r&&(r="kilometers"),!(0<=t))throw new Error("area must be a positive number");if(!(e=n[e]))throw new Error("invalid original units");if(r=n[r])return t/e*r;throw new Error("invalid final units")},isNumber:p,isObject:g,validateBBox:function(t){if(!t)throw new Error("bbox is required");if(!Array.isArray(t))throw new Error("bbox must be an Array");if(4!==t.length&&6!==t.length)throw new Error("bbox must be an Array of 4 or 6 numbers");t.forEach(function(t){if(!p(t))throw new Error("bbox must only contain numbers")})},validateId:function(t){if(!t)throw new Error("id is required");if(-1===["string","number"].indexOf(void 0===t?"undefined":X(t)))throw new Error("id must be a number or a string")}});function M(t,e,r){if(null!==t)for(var o,i,n,s=0,a=t.type,u="FeatureCollection"===a,c="Feature"===a,l=u?t.features.length:1,h=0;h<l;h++)for(var p,f,d=(f=!!(p=u?t.features[h].geometry:c?t.geometry:t)&&"GeometryCollection"===p.type)?p.geometries.length:1,y=0;y<d;y++){var m=0,g=0,_=f?p.geometries[y]:p;if(null!==_){var v=_.coordinates,b=_.type,w=!r||"Polygon"!==b&&"MultiPolygon"!==b?0:1;switch(b){case null:break;case"Point":if(!1===e(v,s,h,m,g))return!1;s++,m++;break;case"LineString":case"MultiPoint":for(o=0;o<v.length;o++){if(!1===e(v[o],s,h,m,g))return!1;s++,"MultiPoint"===b&&m++}"LineString"===b&&m++;break;case"Polygon":case"MultiLineString":for(o=0;o<v.length;o++){for(i=0;i<v[o].length-w;i++){if(!1===e(v[o][i],s,h,m,g))return!1;s++}"MultiLineString"===b&&m++,"Polygon"===b&&g++}"Polygon"===b&&m++;break;case"MultiPolygon":for(o=0;o<v.length;o++){for(i=g=0;i<v[o].length;i++){for(n=0;n<v[o][i].length-w;n++){if(!1===e(v[o][i][n],s,h,m,g))return!1;s++}g++}m++}break;case"GeometryCollection":for(o=0;o<_.geometries.length;o++)if(!1===M(_.geometries[o],e,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}function R(t,e){var r;switch(t.type){case"FeatureCollection":for(r=0;r<t.features.length&&!1!==e(t.features[r].properties,r);r++);break;case"Feature":e(t.properties,0)}}function _(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var r=0;r<t.features.length&&!1!==e(t.features[r],r);r++);}function e(t,e){for(var r,o,i,n,s,a,u,c,l,h=0,p="FeatureCollection"===t.type,f="Feature"===t.type,d=p?t.features.length:1,y=0;y<d;y++){for(s=p?t.features[y].geometry:f?t.geometry:t,u=p?t.features[y].properties:f?t.properties:{},c=p?t.features[y].bbox:f?t.bbox:void 0,l=p?t.features[y].id:f?t.id:void 0,n=(a=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,o=0;o<n;o++)if(null===(i=a?s.geometries[o]:s)){if(!1===e(null,h,u,c,l))return!1}else switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===e(i,h,u,c,l))return!1;break;case"GeometryCollection":for(r=0;r<i.geometries.length;r++)if(!1===e(i.geometries[r],h,u,c,l))return!1;break;default:throw new Error("Unknown Geometry Type")}h++}}function r(t,c){e(t,function(t,e,r,o,i){var n,s=null===t?null:t.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return!1===c(f(t,r,{bbox:o,id:i}),e,0)?!1:void 0}switch(s){case"MultiPoint":n="Point";break;case"MultiLineString":n="LineString";break;case"MultiPolygon":n="Polygon"}for(var a=0;a<t.coordinates.length;a++){var u=t.coordinates[a];if(!1===c(f({type:n,coordinates:u},r),e,a))return!1}})}function I(t,f){r(t,function(n,s,a){var u=0;if(n.geometry){var c,l,h,p,t=n.geometry.type;if("Point"!==t&&"MultiPoint"!==t)return p=h=l=0,!1!==M(n,function(t,e,r,o,i){return void 0===c||l<s||h<o||p<i?(c=t,l=s,h=o,p=i,void(u=0)):(o=y([c,t],n.properties),!1!==f(o,s,a,i,u)&&(u++,void(c=t)))})&&void 0}})}function D(t,s){if(!t)throw new Error("geojson is required");r(t,function(t,e,r){if(null!==t.geometry){var o=t.geometry.type,i=t.geometry.coordinates;switch(o){case"LineString":if(!1===s(t,e,r,0,0))return!1;break;case"Polygon":for(var n=0;n<i.length;n++)if(!1===s(y(i[n],t.properties),e,r,n))return!1}}})}var q=Object.freeze({coordAll:function(t){var e=[];return M(t,function(t){e.push(t)}),e},coordEach:M,coordReduce:function(t,n,s,e){var a=s;return M(t,function(t,e,r,o,i){a=0===e&&void 0===s?t:n(a,t,e,r,o,i)},e),a},featureEach:_,featureReduce:function(t,r,o){var i=o;return _(t,function(t,e){i=0===e&&void 0===o?t:r(i,t,e)}),i},findPoint:function(t,e){if(!g(e=e||{}))throw new Error("options is invalid");var r,o=e.featureIndex||0,i=e.multiFeatureIndex||0,n=e.geometryIndex||0,s=e.coordIndex||0,a=e.properties;switch(t.type){case"FeatureCollection":o<0&&(o=t.features.length+o),a=a||t.features[o].properties,r=t.features[o].geometry;break;case"Feature":a=a||t.properties,r=t.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=t;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":return d(u,a,e);case"MultiPoint":return d(u[i=i<0?u.length+i:i],a,e);case"LineString":return d(u[s=s<0?u.length+s:s],a,e);case"Polygon":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s),d(u[n][s],a,e);case"MultiLineString":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s),d(u[i][s],a,e);case"MultiPolygon":return i<0&&(i=u.length+i),n<0&&(n=u[i].length+n),s<0&&(s=u[i][n].length-s),d(u[i][n][s],a,e)}throw new Error("geojson is invalid")},findSegment:function(t,e){if(!g(e=e||{}))throw new Error("options is invalid");var r,o=e.featureIndex||0,i=e.multiFeatureIndex||0,n=e.geometryIndex||0,s=e.segmentIndex||0,a=e.properties;switch(t.type){case"FeatureCollection":o<0&&(o=t.features.length+o),a=a||t.features[o].properties,r=t.features[o].geometry;break;case"Feature":a=a||t.properties,r=t.geometry;break;case"Point":case"MultiPoint":return null;case"LineString":case"Polygon":case"MultiLineString":case"MultiPolygon":r=t;break;default:throw new Error("geojson is invalid")}if(null===r)return null;var u=r.coordinates;switch(r.type){case"Point":case"MultiPoint":return null;case"LineString":return y([u[s=s<0?u.length+s-1:s],u[s+1]],a,e);case"Polygon":return n<0&&(n=u.length+n),s<0&&(s=u[n].length+s-1),y([u[n][s],u[n][s+1]],a,e);case"MultiLineString":return i<0&&(i=u.length+i),s<0&&(s=u[i].length+s-1),y([u[i][s],u[i][s+1]],a,e);case"MultiPolygon":return i<0&&(i=u.length+i),n<0&&(n=u[i].length+n),s<0&&(s=u[i][n].length-s-1),y([u[i][n][s],u[i][n][s+1]],a,e)}throw new Error("geojson is invalid")},flattenEach:r,flattenReduce:function(t,o,i){var n=i;return r(t,function(t,e,r){n=0===e&&0===r&&void 0===i?t:o(n,t,e,r)}),n},geomEach:e,geomReduce:function(t,n,s){var a=s;return e(t,function(t,e,r,o,i){a=0===e&&void 0===s?t:n(a,t,e,r,o,i)}),a},lineEach:D,lineReduce:function(t,i,n){var s=n;return D(t,function(t,e,r,o){s=0===e&&void 0===n?t:i(s,t,e,r,o)}),s},propEach:R,propReduce:function(t,r,o){var i=o;return R(t,function(t,e){i=0===e&&void 0===o?t:r(i,t,e)}),i},segmentEach:I,segmentReduce:function(t,n,s){var a=s,u=!1;return I(t,function(t,e,r,o,i){a=!1===u&&void 0===s?t:n(a,t,e,r,o,i),u=!0}),a}});function J(e){var r=[];return"FeatureCollection"===e.type?_(e,function(e){M(e,function(t){r.push(d(t,e.properties))})}):M(e,function(t){r.push(d(t,e.properties))}),m(r)}function z(t){if(!t)throw new Error("geojson is required");var e=[];return r(t,function(t){e.push(t)}),m(e)}var W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function H(t){if(!t)throw new Error("geojson is required");switch(t.type){case"Feature":return U(t);case"FeatureCollection":return e=t,r={type:"FeatureCollection"},Object.keys(e).forEach(function(t){switch(t){case"type":case"features":return;default:r[t]=e[t]}}),r.features=e.features.map(U),r;case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return V(t);default:throw new Error("unknown GeoJSON type")}var e,r}function U(e){var r={type:"Feature"};return Object.keys(e).forEach(function(t){switch(t){case"type":case"properties":case"geometry":return;default:r[t]=e[t]}}),r.properties=function r(o){var i={};if(!o)return i;Object.keys(o).forEach(function(t){var e=o[t];"object"===(void 0===e?"undefined":W(e))?null===e?i[t]=null:Array.isArray(e)?i[t]=e.map(function(t){return t}):i[t]=r(e):i[t]=e});return i}(e.properties),r.geometry=V(e.geometry),r}function V(t){var e={type:t.type};return t.bbox&&(e.bbox=t.bbox),"GeometryCollection"===t.type?e.geometries=t.geometries.map(V):e.coordinates=function e(t){if("object"!==W(t[0]))return t.slice();return t.map(function(t){return e(t)})}(t.coordinates),e}function v(t){if(!t)throw new Error("coord is required");if(!Array.isArray(t)){if("Feature"===t.type&&null!==t.geometry&&"Point"===t.geometry.type)return t.geometry.coordinates;if("Point"===t.type)return t.coordinates}if(Array.isArray(t)&&2<=t.length&&!Array.isArray(t[0])&&!Array.isArray(t[1]))return t;throw new Error("coord must be GeoJSON Point or an Array of numbers")}function b(t){if(Array.isArray(t))return t;if("Feature"===t.type){if(null!==t.geometry)return t.geometry.coordinates}else if(t.coordinates)return t.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function K(t){return"Feature"===t.type?t.geometry:t}function w(t,e,r){void 0===r&&(r={});var t=v(t),e=v(e),o=h(e[1]-t[1]),i=h(e[0]-t[0]),t=h(t[1]),e=h(e[1]),o=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(i/2),2)*Math.cos(t)*Math.cos(e);return u(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),r.units)}function Q(t,e,r){if(!0===(r=void 0===r?{}:r).final)return(Q(e,t)+180)%360;var r=v(t),t=v(e),e=h(r[0]),o=h(t[0]),r=h(r[1]),t=h(t[1]),i=Math.sin(o-e)*Math.cos(t),r=Math.cos(r)*Math.sin(t)-Math.sin(r)*Math.cos(t)*Math.cos(o-e);return l(Math.atan2(i,r))}function Z(t,e,r,o){void 0===o&&(o={});var t=v(t),i=h(t[0]),t=h(t[1]),r=h(r),e=c(e,o.units),n=Math.asin(Math.sin(t)*Math.cos(e)+Math.cos(t)*Math.sin(e)*Math.cos(r));return d([l(i+Math.atan2(Math.sin(r)*Math.sin(e)*Math.cos(t),Math.cos(e)-Math.sin(t)*Math.sin(n))),l(n)],o.properties)}function $(t){if(!t)throw new Error("geojson is required");var n=[];return r(t,function(t){var e=t,r=n,o=[],i=e.geometry;if(null!==i){switch(i.type){case"Polygon":o=b(i);break;case"LineString":o=[b(i)]}o.forEach(function(t){var s,a;s=e.properties,a=[],t.reduce(function(t,e){var r,o,i,n=y([t,e],s);return n.bbox=(r=e,o=(t=t)[0],t=t[1],i=r[0],r=r[1],[o<i?o:i,t<r?t:r,i<o?o:i,r<t?t:r]),a.push(n),e}),a.forEach(function(t){t.id=r.length,r.push(t)})})}}),m(n)}function tt(t,e,r,o,i){!function t(e,r,o,i,n){for(;o<i;){600<i-o&&(s=i-o+1,l=r-o+1,u=Math.log(s),a=.5*Math.exp(2*u/3),u=.5*Math.sqrt(u*a*(s-a)/s)*(l-s/2<0?-1:1),c=Math.max(o,Math.floor(r-l*a/s+u)),l=Math.min(i,Math.floor(r+(s-l)*a/s+u)),t(e,r,c,l,n));var s,a,u,c,l,h=e[r],p=o,f=i;for(P(e,o,r),0<n(e[i],h)&&P(e,o,i);p<f;){for(P(e,p,f),p++,f--;n(e[p],h)<0;)p++;for(;0<n(e[f],h);)f--}0===n(e[o],h)?P(e,o,f):P(e,++f,i),f<=r&&(o=f+1),r<=f&&(i=f-1)}}(t,e,r||0,o||t.length-1,i||et)}function P(t,e,r){var o=t[e];t[e]=t[r],t[r]=o}function et(t,e){return t<e?-1:e<t?1:0}x.prototype.all=function(){return this._all(this.data,[])},x.prototype.search=function(t){var e=this.data,r=[];if(!k(t,e))return r;for(var o=this.toBBox,i=[];e;){for(var n=0;n<e.children.length;n++){var s=e.children[n],a=e.leaf?o(s):s;k(t,a)&&(e.leaf?r.push(s):st(t,a)?this._all(s,r):i.push(s))}e=i.pop()}return r},x.prototype.collides=function(t){var e=this.data;if(!k(t,e))return!1;for(var r=[];e;){for(var o=0;o<e.children.length;o++){var i=e.children[o],n=e.leaf?this.toBBox(i):i;if(k(t,n)){if(e.leaf||st(t,n))return!0;r.push(i)}}e=r.pop()}return!1},x.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var r,o=this._build(t.slice(),0,t.length-1,0);return this.data.children.length?this.data.height===o.height?this._splitRoot(this.data,o):(this.data.height<o.height&&(r=this.data,this.data=o,o=r),this._insert(o,this.data.height-o.height-1,!0)):this.data=o,this},x.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},x.prototype.clear=function(){return this.data=A([]),this},x.prototype.remove=function(t,e){if(!t)return this;for(var r=this.data,o=this.toBBox(t),i=[],n=[],s=void 0,a=void 0,u=void 0;r||i.length;){if(r||(r=i.pop(),a=i[i.length-1],s=n.pop(),u=!0),r.leaf){var c=function(t,e,r){if(!r)return e.indexOf(t);for(var o=0;o<e.length;o++)if(r(t,e[o]))return o;return-1}(t,r.children,e);if(-1!==c)return r.children.splice(c,1),i.push(r),this._condense(i),this}u||r.leaf||!st(r,o)?a?(s++,r=a.children[s],u=!1):r=null:(i.push(r),n.push(s),r=(a=r).children[s=0])}return this},x.prototype.toBBox=function(t){return t},x.prototype.compareMinX=function(t,e){return t.minX-e.minX},x.prototype.compareMinY=function(t,e){return t.minY-e.minY},x.prototype.toJSON=function(){return this.data},x.prototype.fromJSON=function(t){return this.data=t,this},x.prototype._all=function(t,e){for(var r=[];t;)t.leaf?e.push.apply(e,t.children):r.push.apply(r,t.children),t=r.pop();return e},x.prototype._build=function(t,e,r,o){var i=r-e+1,n=this._maxEntries,s=void 0;if(i<=n)return E(s=A(t.slice(e,r+1)),this.toBBox),s;o||(o=Math.ceil(Math.log(i)/Math.log(n)),n=Math.ceil(i/Math.pow(n,o-1))),(s=A([])).leaf=!1,s.height=o;var a=Math.ceil(i/n),u=a*Math.ceil(Math.sqrt(n));at(t,e,r,u,this.compareMinX);for(var c=e;c<=r;c+=u){var l=Math.min(c+u-1,r);at(t,c,l,a,this.compareMinY);for(var h=c;h<=l;h+=a){var p=Math.min(h+a-1,l);s.children.push(this._build(t,h,p,o-1))}}return E(s,this.toBBox),s},x.prototype._chooseSubtree=function(t,e,r,o){for(;;){if(o.push(e),e.leaf||o.length-1===r)break;for(var i=1/0,n=1/0,s=void 0,a=0;a<e.children.length;a++){var u=e.children[a],c=nt(u),l=(h=t,l=u,(Math.max(l.maxX,h.maxX)-Math.min(l.minX,h.minX))*(Math.max(l.maxY,h.maxY)-Math.min(l.minY,h.minY))-c);l<n?(n=l,i=c<i?c:i,s=u):l===n&&c<i&&(i=c,s=u)}e=s||e.children[0]}var h,l;return e},x.prototype._insert=function(t,e,r){var r=r?t:this.toBBox(t),o=[],i=this._chooseSubtree(r,this.data,e,o);for(i.children.push(t),L(i,r);0<=e&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(r,o,e)},x.prototype._split=function(t,e){var r=t[e],o=r.children.length,i=this._minEntries,i=(this._chooseSplitAxis(r,i,o),this._chooseSplitIndex(r,i,o)),o=A(r.children.splice(i,r.children.length-i));o.height=r.height,o.leaf=r.leaf,E(r,this.toBBox),E(o,this.toBBox),e?t[e-1].children.push(o):this._splitRoot(r,o)},x.prototype._splitRoot=function(t,e){this.data=A([t,e]),this.data.height=t.height+1,this.data.leaf=!1,E(this.data,this.toBBox)},x.prototype._chooseSplitIndex=function(t,e,r){for(var o,i,n,s=void 0,a=1/0,u=1/0,c=e;c<=r-e;c++){var l=S(t,0,c,this.toBBox),h=S(t,c,r,this.toBBox),p=(o=l,p=h,f=n=i=void 0,i=Math.max(o.minX,p.minX),n=Math.max(o.minY,p.minY),f=Math.min(o.maxX,p.maxX),o=Math.min(o.maxY,p.maxY),Math.max(0,f-i)*Math.max(0,o-n)),f=nt(l)+nt(h);p<a?(a=p,s=c,u=f<u?f:u):p===a&&f<u&&(u=f,s=c)}return s||r-e},x.prototype._chooseSplitAxis=function(t,e,r){var o=t.leaf?this.compareMinX:ot,i=t.leaf?this.compareMinY:it;this._allDistMargin(t,e,r,o)<this._allDistMargin(t,e,r,i)&&t.children.sort(o)},x.prototype._allDistMargin=function(t,e,r,o){t.children.sort(o);for(var i=this.toBBox,n=S(t,0,e,i),s=S(t,r-e,r,i),a=C(n)+C(s),u=e;u<r-e;u++){var c=t.children[u];L(n,t.leaf?i(c):c),a+=C(n)}for(var l=r-e-1;e<=l;l--){var h=t.children[l];L(s,t.leaf?i(h):h),a+=C(s)}return a},x.prototype._adjustParentBBoxes=function(t,e,r){for(var o=r;0<=o;o--)L(e[o],t)},x.prototype._condense=function(t){for(var e,r=t.length-1;0<=r;r--)0===t[r].children.length?0<r?(e=t[r-1].children).splice(e.indexOf(t[r]),1):this.clear():E(t[r],this.toBBox)};var rt=x;function x(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:9,e=this,r=x;if(!(e instanceof r))throw new TypeError("Cannot call a class as a function");this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}function E(t,e){S(t,0,t.children.length,e,t)}function S(t,e,r,o,i){(i=i||A(null)).minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var n=e;n<r;n++){var s=t.children[n];L(i,t.leaf?o(s):s)}return i}function L(t,e){t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY)}function ot(t,e){return t.minX-e.minX}function it(t,e){return t.minY-e.minY}function nt(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function C(t){return t.maxX-t.minX+(t.maxY-t.minY)}function st(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function k(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function A(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function at(t,e,r,o,i){for(var n,s=[e,r];s.length;)(r=s.pop())-(e=s.pop())<=o||(tt(t,n=e+Math.ceil((r-e)/o/2)*o,e,r,i),s.push(e,n,n,r))}var ut=Object.freeze({default:rt});function F(t){var e=[1/0,1/0,-1/0,-1/0];return M(t,function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])}),e}F.default=F;var ct=Object.freeze({default:F}),O=ut&&rt,T=(ct&&F).default,lt=q.featureEach,ht=t.featureCollection;function pt(t){t=new O(t);return t.insert=function(t){if("Feature"!==t.type)throw new Error("invalid feature");return t.bbox=t.bbox||T(t),O.prototype.insert.call(this,t)},t.load=function(t){var e=[];return Array.isArray(t)?t.forEach(function(t){if("Feature"!==t.type)throw new Error("invalid features");t.bbox=t.bbox||T(t),e.push(t)}):lt(t,function(t){if("Feature"!==t.type)throw new Error("invalid features");t.bbox=t.bbox||T(t),e.push(t)}),O.prototype.load.call(this,e)},t.remove=function(t,e){if("Feature"!==t.type)throw new Error("invalid feature");return t.bbox=t.bbox||T(t),O.prototype.remove.call(this,t,e)},t.clear=function(){return O.prototype.clear.call(this)},t.search=function(t){t=O.prototype.search.call(this,this.toBBox(t));return ht(t)},t.collides=function(t){return O.prototype.collides.call(this,this.toBBox(t))},t.all=function(){var t=O.prototype.all.call(this);return ht(t)},t.toJSON=function(){return O.prototype.toJSON.call(this)},t.fromJSON=function(t){return O.prototype.fromJSON.call(this,t)},t.toBBox=function(t){var e;if(t.bbox)e=t.bbox;else if(Array.isArray(t)&&4===t.length)e=t;else if(Array.isArray(t)&&6===t.length)e=[t[0],t[1],t[3],t[4]];else if("Feature"===t.type)e=T(t);else{if("FeatureCollection"!==t.type)throw new Error("invalid geojson");e=T(t)}return{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}},t}var G=pt;function ft(t,e){t=b(t),e=b(e);if(2!==t.length)throw new Error("<intersects> line1 must only contain 2 coordinates");if(2!==e.length)throw new Error("<intersects> line2 must only contain 2 coordinates");var r=t[0][0],o=t[0][1],i=t[1][0],t=t[1][1],n=e[0][0],s=e[0][1],a=e[1][0],e=e[1][1],u=(e-s)*(i-r)-(a-n)*(t-o),a=(a-n)*(o-s)-(e-s)*(r-n),e=(i-r)*(o-s)-(t-o)*(r-n);if(0==u)return null;s=a/u,n=e/u;return 0<=s&&s<=1&&0<=n&&n<=1?d([r+s*(i-r),o+s*(t-o)]):null}function dt(t,c,l){void 0===l&&(l={});var h=d([1/0,1/0],{dist:1/0}),p=0;return r(t,function(t){for(var e=b(t),r=0;r<e.length-1;r++){var o=d(e[r]),i=(o.properties.dist=w(c,o,l),d(e[r+1])),n=(i.properties.dist=w(c,i,l),w(o,i,l)),s=Math.max(o.properties.dist,i.properties.dist),a=Q(o,i),u=Z(c,s,a+90,l),s=Z(c,s,a-90,l),a=function(t,e){var r,o={},i=[];if("LineString"===t.type&&(t=f(t)),"LineString"===e.type&&(e=f(e)),"Feature"===t.type&&"Feature"===e.type&&null!==t.geometry&&null!==e.geometry&&"LineString"===t.geometry.type&&"LineString"===e.geometry.type&&2===t.geometry.coordinates.length&&2===e.geometry.coordinates.length)return(r=ft(t,e))&&i.push(r),m(i);var n=G();return n.load($(e)),_($(t),function(r){_(n.search(r),function(t){var e,t=ft(r,t);t&&(e=b(t).join(","),o[e]||(o[e]=!0,i.push(t)))})}),m(i)}(y([u.geometry.coordinates,s.geometry.coordinates]),y([o.geometry.coordinates,i.geometry.coordinates])),u=null;0<a.features.length&&((u=a.features[0]).properties.dist=w(c,u,l),u.properties.location=p+w(o,u,l)),o.properties.dist<h.properties.dist&&((h=o).properties.index=r,h.properties.location=p),i.properties.dist<h.properties.dist&&((h=i).properties.index=r+1,h.properties.location=p+n),u&&u.properties.dist<h.properties.dist&&((h=u).properties.index=r),p+=n}}),h}G.default=pt;function yt(t,e){void 0===e&&(e={});var r,o,i,n,s,a=K(t);switch(e.properties||"Feature"!==t.type||(e.properties=t.properties),a.type){case"Polygon":return void 0===(n=e)&&(n={}),s=K(i=a).coordinates,n=n.properties||("Feature"===i.type?i.properties:{}),mt(s,n);case"MultiPolygon":return void 0===(i=e)&&(i={}),n=K(s=a).coordinates,r=i.properties||("Feature"===s.type?s.properties:{}),o=[],n.forEach(function(t){o.push(mt(t,r))}),m(o);default:throw new Error("invalid poly")}}function mt(t,e){return 1<t.length?a(t,e):y(t[0],e)}function gt(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);if(t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e)if(Object.setPrototypeOf)Object.setPrototypeOf(t,e);else for(var r=t,o=e,i=Object.getOwnPropertyNames(o),n=0;n<i.length;n++){var s=i[n],a=Object.getOwnPropertyDescriptor(o,s);a&&a.configurable&&void 0===r[s]&&Object.defineProperty(r,s,a)}}var _t,vt=o.INTERNAL_LAYER_PREFIX+"cxiaof_autoadsorb",ut=(gt(B,_t=o.Class),B.prototype.setMode=function(t){return this.options.mode=t,this._updateGeosSet(),this},B.prototype.getMode=function(){return this.options.mode},B.prototype.setDistance=function(t){return this.options.distance=t,this._updateGeosSet(),this},B.prototype.getDistance=function(){return this.options.distance},B.prototype.refreshTargets=function(){return this._updateGeosSet(),this},B.prototype.isEnable=function(){return this._isEnable},B.prototype.bindDrawTool=function(t){return t instanceof o.DrawTool&&(this._map||this._addTo(t.getMap()),(this._drawTool=t).on("enable",this._enable,this),t.on("disable remove",this._disable,this),t.isEnabled()&&this._enable()),this},B.prototype.bindGeometry=function(t){return t instanceof o.Geometry&&(this._map||this._addTo(drawTool.getMap()),this._disableMapTool(),(this._geometry=t).on("editstart",this._enable,this),t.on("editend remove",this._disable,this),t.isEditing()&&this._enable()),this},B.prototype.remove=function(){this._disable(),this._cursorLayer&&this._cursorLayer.remove(),delete this._needDeal,delete this._treePoints,delete this._treeLines,delete this._cursorLayer,delete this._assistLayers,delete this._mousePoint,delete this._geosSetPoint,delete this._geosSetLine,delete this._cursor,delete this._adsorbPoint,delete this._drawTool,delete this._map},B.prototype._addTo=function(t){this._map=t,this._newCursorLayer(),this._saveAdsorbLayers()},B.prototype._newCursorLayer=function(){this._cursorLayer=new o.VectorLayer(vt,{style:{symbol:this.options.cursorSymbol}}),this._cursorLayer.addTo(this._map).bringToFront()},B.prototype._saveAdsorbLayers=function(){var e=this;this._assistLayers=[],this.options.layers.forEach(function(t){(t="string"==typeof t?e._map.getLayer(t):t)instanceof o.VectorLayer&&e._assistLayers.push(t)})},B.prototype._enable=function(){this._isEnable=!0,this._cursorLayer&&this._cursorLayer.show(),this._updateGeosSet(),this._registerMapEvents(),this._geometry?this._registerGeometryEvents():this._registerDrawToolEvents()},B.prototype._updateGeosSet=function(){this._geosSetPoint=[],this._geosSetLine=[];var t=this._getAllAssistGeos();["auto","vertux"].includes(this.options.mode)&&(this._geosSetPoint=this._parseToPoints(t)),["auto","border"].includes(this.options.mode)&&(this._geosSetLine=this._parseToLines(t)),this._updateRBushTree()},B.prototype._getAllAssistGeos=function(){return this._assistLayers.reduce(function(t,e){return t.concat(e.getGeometries())},[])},B.prototype._parseToPoints=function(t){var e=this,r=[];return t.forEach(function(t){r=(t instanceof o.GeometryCollection||(t instanceof o.Circle||t instanceof o.Ellipse)&&((t=t.copy()).setOptions(Object.assign(t.options||{},{numberOfShellPoints:e.options.shellPoints})),r.push(e._getCenterFeature(t))),r.concat(J(t.toGeoJSON()).features))}),r},B.prototype._getCenterFeature=function(t){return{type:"Feature",geometry:{type:"Point",coordinates:t.getCenter().toArray()},properties:{}}},B.prototype._parseToLines=function(t){var e=this,r=[];return(t=t.filter(function(t){return!(t instanceof o.Marker||t instanceof o.MultiPoint)})).forEach(function(t){t instanceof o.LineString?r.push(t.toGeoJSON()):r=t instanceof o.MultiLineString?r.concat(z(t.toGeoJSON()).features):((t instanceof o.Circle||t instanceof o.Ellipse)&&(t=t.copy()).setOptions(Object.assign(t.options||{},{numberOfShellPoints:e.options.shellPoints})),r.concat(e._polygonToLine(t.toGeoJSON())))}),this._splitLines(r)},B.prototype._polygonToLine=function(t){t=yt(t);return"Feature"===t.type?z(t).features:t.features.reduce(function(t,e){return t.concat(z(e).features)},[])},B.prototype._splitLines=function(t){return t.reduce(function(t,e){for(var r=e.geometry.coordinates,o=0;o<r.length-1;o++){var i=[r[o],r[o+1]];t.push({type:"Feature",geometry:{type:"LineString",coordinates:i},properties:{}})}return t},[])},B.prototype._updateRBushTree=function(){this._treePoints.clear(),this._treePoints.load({type:"FeatureCollection",features:this._geosSetPoint}),this._treeLines.clear(),this._treeLines.load({type:"FeatureCollection",features:this._geosSetLine})},B.prototype._registerMapEvents=function(){this._map.on("mousedown",this._mapMousedown,this),this._map.on("mouseup",this._mapMouseup,this),this._map.on("mousemove",this._mapMousemove,this)},B.prototype._mapMousedown=function(){this._needFindGeometry=!!this._geometry},B.prototype._mapMouseup=function(){this._needFindGeometry=!this._geometry},B.prototype._mapMousemove=function(t){var e=t.coordinate,t=t.domEvent;this._needDeal=!0,this._mousePoint=e,this._cursor?this._cursor.setCoordinates(e):(this._cursor=new o.Marker(e),this._cursor.addTo(this._cursorLayer)),delete this._adsorbPoint,this.options.needCtrl===t.ctrlKey&&this._updateAdsorbPoint(e)},B.prototype._updateAdsorbPoint=function(t){var e;this._needFindGeometry&&(0<(t=this._findGeometry(t)).length&&(this._adsorbPoint=this._getAdsorbPoint(t)),this._adsorbPoint&&(e=(t=this._adsorbPoint).x,t=t.y,this._cursor.setCoordinates([e,t])))},B.prototype._findGeometry=function(t){var e,r=[];return 0<this._geosSetPoint.length&&(e=this._findAvailGeos(this._treePoints,t),r=r.concat(e)),0<this._geosSetLine.length&&(e=this._findAvailGeos(this._treeLines,t),r=r.concat(e)),r},B.prototype._findAvailGeos=function(t,e){e=this._createInspectExtent(e);return t.search(e).features},B.prototype._createInspectExtent=function(t){var e=this._map.pixelToDistance(0,this.options.distance);return new o.Circle(t,e,{properties:{},numberOfShellPoints:this.options.shellPoints}).toGeoJSON()},B.prototype._getAdsorbPoint=function(t){var e=[this._mousePoint.x,this._mousePoint.y],r=t.filter(function(t){return"Point"===t.geometry.type}),t=(0<r.length?this._getNearestPoint(e,r):(r=t.filter(function(t){return"LineString"===t.geometry.type}),this._getNearestPointOnLine(e,r))).geometry.coordinates;return{x:t[0],y:t[1]}},B.prototype._getNearestPoint=function(t,e){var r=t,t={type:"FeatureCollection",features:e};if(!r)throw new Error("targetPoint is required");if(!t)throw new Error("points is required");var o=1/0,i=0;return _(t,function(t,e){t=w(r,t);t<o&&(i=e,o=t)}),(t=H(t.features[i])).properties.featureIndex=i,t.properties.distanceToPoint=o,t},B.prototype._getNearestPointOnLine=function(t,e){var o;return o={MultiPoint:{coordinates:[],properties:[]},MultiLineString:{coordinates:[],properties:[]},MultiPolygon:{coordinates:[],properties:[]}},_({type:"FeatureCollection",features:e},function(t){var e,r;switch(null==(r=t.geometry)?void 0:r.type){case"Point":o.MultiPoint.coordinates.push(t.geometry.coordinates),o.MultiPoint.properties.push(t.properties);break;case"MultiPoint":(e=o.MultiPoint.coordinates).push.apply(e,t.geometry.coordinates),o.MultiPoint.properties.push(t.properties);break;case"LineString":o.MultiLineString.coordinates.push(t.geometry.coordinates),o.MultiLineString.properties.push(t.properties);break;case"MultiLineString":(e=o.MultiLineString.coordinates).push.apply(e,t.geometry.coordinates),o.MultiLineString.properties.push(t.properties);break;case"Polygon":o.MultiPolygon.coordinates.push(t.geometry.coordinates),o.MultiPolygon.properties.push(t.properties);break;case"MultiPolygon":(e=o.MultiPolygon.coordinates).push.apply(e,t.geometry.coordinates),o.MultiPolygon.properties.push(t.properties)}}),dt(m(Object.keys(o).filter(function(t){return o[t].coordinates.length}).sort().map(function(t){return f({type:t,coordinates:o[t].coordinates},{collectedProperties:o[t].properties})})),t)},B.prototype._registerGeometryEvents=function(){this._geometry.on("handledragging",this._setShadowCenter,this),this._geometry.on("editrecord",this._resetShadowCenter,this)},B.prototype._setShadowCoordinates=function(t){this._needDeal&&this._adsorbPoint&&t.target},B.prototype._setShadowCenter=function(t){this._handledragging=!0;var t=t.target,e=t.getCenter(),r=this._adsorbPoint||this._mousePoint,e=this._getCoordsOffset(e,r);t.translate.apply(t,e)},B.prototype._getCoordsOffset=function(t,e){return[e.x-t.x,e.y-t.y]},B.prototype._resetShadowCenter=function(t){var e,r;this._handledragging&&this._adsorbPoint&&(r=(t=t.target).getCenter(),e=this._adsorbPoint,r=this._getCoordsOffset(r,e),t.translate.apply(t,r),(e=t._editor._shadow).translate.apply(e,r),delete this._handledragging)},B.prototype._registerDrawToolEvents=function(){this._drawTool.on("drawstart drawvertex",this._resetCoordsAndPoint,this),this._drawTool.on("mousemove drawend",this._resetCoordinates,this)},B.prototype._resetCoordsAndPoint=function(t){this._resetCoordinates(t),this._resetClickPoint(t)},B.prototype._resetCoordinates=function(t){if(this._adsorbPoint){var e=t.target,r=e.options.mode,o=e._geometry,i=o.getCoordinates(),e=this._adsorbPoint,n=e.x,s=e.y;switch(r){case"Point":o.setCoordinates(this._adsorbPoint);break;case"Rectangle":i[0][1].x=n,i[0][2].x=n,i[0][2].y=s,i[0][3].y=s,o.setCoordinates(i);break;case"Circle":if("drawstart"===t.type)return void o.setCoordinates(this._adsorbPoint);var a=this._map.getProjection().measureLength([i,this._adsorbPoint]);o.setRadius(a);break;case"Ellipse":if("drawstart"===t.type)return void o.setCoordinates(this._adsorbPoint);var a=this._map.getProjection().measureLength([i,{x:n,y:i.y}]),u=this._map.getProjection().measureLength([i,{x:i.x,y:s}]);o.setWidth(2*a).setHeight(2*u)._updateCache();break;default:i.pop(),i.push(this._adsorbPoint),o.setCoordinates(i)}}},B.prototype._resetClickPoint=function(t){var e;this._adsorbPoint&&(t=t.target._clickCoords,e=this._map.coordToPoint(this._adsorbPoint),t.pop(),t.push(this._map._pointToPrj(e)))},B.prototype._disable=function(){this._isEnable=!1,this._cursorLayer&&this._cursorLayer.hide(),this._offMapEvents(),this._geometry?this._offGeometryEvents():this._offDrawToolEvents(),this._resetGeosSet(),delete this._geometry},B.prototype._offMapEvents=function(){this._map.off("mousedown",this._mapMousedown,this),this._map.off("mousemove",this._mapMousemove,this),this._map.off("mouseup",this._mapMouseup,this)},B.prototype._offGeometryEvents=function(){this._geometry.off("handledragging",this._setShadowCenter,this),this._geometry.off("editrecord",this._resetShadowCenter,this)},B.prototype._offDrawToolEvents=function(){this._drawTool.off("drawstart drawvertex",this._resetCoordsAndPoint,this),this._drawTool.off("mousemove drawend",this._resetCoordinates,this)},B.prototype._resetGeosSet=function(){this._geosSetPoint=[],this._geosSetLine=[]},B.prototype._disableMapTool=function(){this._map._map_tool&&this._map._map_tool.disable()},B);function B(t){if(!(this instanceof B))throw new TypeError("Cannot call a class as a function");t=function(t,e){if(t)return!e||"object"!=typeof e&&"function"!=typeof e?t:e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(this,_t.call(this,t));return t._isEnable=!1,t._treePoints=G(),t._treeLines=G(),t}ut.mergeOptions({layers:[],mode:"auto",distance:10,shellPoints:60,needCtrl:!1,cursorSymbol:{markerType:"ellipse",markerFill:"#de3333",markerWidth:4,markerHeight:4,markerLineWidth:0}}),j.Autoadsorb=ut,Object.defineProperty(j,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.autoadsorb v0.4.0, requires maptalks@>=0.46.0.")});